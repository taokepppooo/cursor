"use strict";var dc=Object.create;var Vt=Object.defineProperty;var pc=Object.getOwnPropertyDescriptor;var mc=Object.getOwnPropertyNames;var gc=Object.getPrototypeOf,vc=Object.prototype.hasOwnProperty;var E=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),yc=(r,e)=>{for(var t in e)Vt(r,t,{get:e[t],enumerable:!0})},rn=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of mc(e))!vc.call(r,n)&&n!==t&&Vt(r,n,{get:()=>e[n],enumerable:!(s=pc(e,n))||s.enumerable});return r};var O=(r,e,t)=>(t=r!=null?dc(gc(r)):{},rn(e||!r||!r.__esModule?Vt(t,"default",{value:r,enumerable:!0}):t,r)),Ec=r=>rn(Vt({},"__esModule",{value:!0}),r);var Tn=E((ip,En)=>{"use strict";var{Duplex:$c}=require("stream");function vn(r){r.emit("close")}function Oc(){!this.destroyed&&this._writableState.finished&&this.destroy()}function yn(r){this.removeListener("error",yn),this.destroy(),this.listenerCount("error")===0&&this.emit("error",r)}function Lc(r,e){let t=!0,s=new $c({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return r.on("message",function(i,o){let a=!o&&s._readableState.objectMode?i.toString():i;s.push(a)||r.pause()}),r.once("error",function(i){s.destroyed||(t=!1,s.destroy(i))}),r.once("close",function(){s.destroyed||s.push(null)}),s._destroy=function(n,i){if(r.readyState===r.CLOSED){i(n),process.nextTick(vn,s);return}let o=!1;r.once("error",function(c){o=!0,i(c)}),r.once("close",function(){o||i(n),process.nextTick(vn,s)}),t&&r.terminate()},s._final=function(n){if(r.readyState===r.CONNECTING){r.once("open",function(){s._final(n)});return}r._socket!==null&&(r._socket._writableState.finished?(n(),s._readableState.endEmitted&&s.destroy()):(r._socket.once("finish",function(){n()}),r.close()))},s._read=function(){r.isPaused&&r.resume()},s._write=function(n,i,o){if(r.readyState===r.CONNECTING){r.once("open",function(){s._write(n,i,o)});return}r.send(n,o)},s.on("end",Oc),s.on("error",yn),s}En.exports=Lc});var Ee=E((op,bn)=>{"use strict";var wn=["nodebuffer","arraybuffer","fragments"],Sn=typeof Blob<"u";Sn&&wn.push("blob");bn.exports={BINARY_TYPES:wn,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:Sn,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var gt=E((ap,Gt)=>{"use strict";var{EMPTY_BUFFER:Ac}=Ee(),jr=Buffer[Symbol.species];function Fc(r,e){if(r.length===0)return Ac;if(r.length===1)return r[0];let t=Buffer.allocUnsafe(e),s=0;for(let n=0;n<r.length;n++){let i=r[n];t.set(i,s),s+=i.length}return s<e?new jr(t.buffer,t.byteOffset,s):t}function xn(r,e,t,s,n){for(let i=0;i<n;i++)t[s+i]=r[i]^e[i&3]}function _n(r,e){for(let t=0;t<r.length;t++)r[t]^=e[t&3]}function Dc(r){return r.length===r.buffer.byteLength?r.buffer:r.buffer.slice(r.byteOffset,r.byteOffset+r.length)}function Ur(r){if(Ur.readOnly=!0,Buffer.isBuffer(r))return r;let e;return r instanceof ArrayBuffer?e=new jr(r):ArrayBuffer.isView(r)?e=new jr(r.buffer,r.byteOffset,r.byteLength):(e=Buffer.from(r),Ur.readOnly=!1),e}Gt.exports={concat:Fc,mask:xn,toArrayBuffer:Dc,toBuffer:Ur,unmask:_n};if(!process.env.WS_NO_BUFFER_UTIL)try{let r=require("bufferutil");Gt.exports.mask=function(e,t,s,n,i){i<48?xn(e,t,s,n,i):r.mask(e,t,s,n,i)},Gt.exports.unmask=function(e,t){e.length<32?_n(e,t):r.unmask(e,t)}}catch{}});var Cn=E((cp,Pn)=>{"use strict";var In=Symbol("kDone"),Mr=Symbol("kRun"),Br=class{constructor(e){this[In]=()=>{this.pending--,this[Mr]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Mr]()}[Mr](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[In])}}};Pn.exports=Br});var Et=E((lp,$n)=>{"use strict";var vt=require("zlib"),Rn=gt(),Vc=Cn(),{kStatusCode:kn}=Ee(),qc=Buffer[Symbol.species],Wc=Buffer.from([0,0,255,255]),Ht=Symbol("permessage-deflate"),Te=Symbol("total-length"),yt=Symbol("callback"),Ce=Symbol("buffers"),Xt=Symbol("error"),zt,Gr=class{constructor(e,t,s){if(this._maxPayload=s|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!zt){let n=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;zt=new Vc(n)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[yt];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,s=e.find(n=>!(t.serverNoContextTakeover===!1&&n.server_no_context_takeover||n.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>n.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!n.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(s.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?s.client_max_window_bits=t.clientMaxWindowBits:(s.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete s.client_max_window_bits,s}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(s=>{let n=t[s];if(n.length>1)throw new Error(`Parameter "${s}" must have only a single value`);if(n=n[0],s==="client_max_window_bits"){if(n!==!0){let i=+n;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${n}`);n=i}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${s}": ${n}`)}else if(s==="server_max_window_bits"){let i=+n;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${n}`);n=i}else if(s==="client_no_context_takeover"||s==="server_no_context_takeover"){if(n!==!0)throw new TypeError(`Invalid value for parameter "${s}": ${n}`)}else throw new Error(`Unknown parameter "${s}"`);t[s]=n})}),e}decompress(e,t,s){zt.add(n=>{this._decompress(e,t,(i,o)=>{n(),s(i,o)})})}compress(e,t,s){zt.add(n=>{this._compress(e,t,(i,o)=>{n(),s(i,o)})})}_decompress(e,t,s){let n=this._isServer?"client":"server";if(!this._inflate){let i=`${n}_max_window_bits`,o=typeof this.params[i]!="number"?vt.Z_DEFAULT_WINDOWBITS:this.params[i];this._inflate=vt.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[Ht]=this,this._inflate[Te]=0,this._inflate[Ce]=[],this._inflate.on("error",Uc),this._inflate.on("data",Nn)}this._inflate[yt]=s,this._inflate.write(e),t&&this._inflate.write(Wc),this._inflate.flush(()=>{let i=this._inflate[Xt];if(i){this._inflate.close(),this._inflate=null,s(i);return}let o=Rn.concat(this._inflate[Ce],this._inflate[Te]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Te]=0,this._inflate[Ce]=[],t&&this.params[`${n}_no_context_takeover`]&&this._inflate.reset()),s(null,o)})}_compress(e,t,s){let n=this._isServer?"server":"client";if(!this._deflate){let i=`${n}_max_window_bits`,o=typeof this.params[i]!="number"?vt.Z_DEFAULT_WINDOWBITS:this.params[i];this._deflate=vt.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[Te]=0,this._deflate[Ce]=[],this._deflate.on("data",jc)}this._deflate[yt]=s,this._deflate.write(e),this._deflate.flush(vt.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let i=Rn.concat(this._deflate[Ce],this._deflate[Te]);t&&(i=new qc(i.buffer,i.byteOffset,i.length-4)),this._deflate[yt]=null,this._deflate[Te]=0,this._deflate[Ce]=[],t&&this.params[`${n}_no_context_takeover`]&&this._deflate.reset(),s(null,i)})}};$n.exports=Gr;function jc(r){this[Ce].push(r),this[Te]+=r.length}function Nn(r){if(this[Te]+=r.length,this[Ht]._maxPayload<1||this[Te]<=this[Ht]._maxPayload){this[Ce].push(r);return}this[Xt]=new RangeError("Max payload size exceeded"),this[Xt].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[Xt][kn]=1009,this.removeListener("data",Nn),this.reset()}function Uc(r){this[Ht]._inflate=null,r[kn]=1007,this[yt](r)}});var Ye=E((up,Jt)=>{"use strict";var{isUtf8:On}=require("buffer"),{hasBlob:Mc}=Ee(),Bc=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function Gc(r){return r>=1e3&&r<=1014&&r!==1004&&r!==1005&&r!==1006||r>=3e3&&r<=4999}function zr(r){let e=r.length,t=0;for(;t<e;)if(!(r[t]&128))t++;else if((r[t]&224)===192){if(t+1===e||(r[t+1]&192)!==128||(r[t]&254)===192)return!1;t+=2}else if((r[t]&240)===224){if(t+2>=e||(r[t+1]&192)!==128||(r[t+2]&192)!==128||r[t]===224&&(r[t+1]&224)===128||r[t]===237&&(r[t+1]&224)===160)return!1;t+=3}else if((r[t]&248)===240){if(t+3>=e||(r[t+1]&192)!==128||(r[t+2]&192)!==128||(r[t+3]&192)!==128||r[t]===240&&(r[t+1]&240)===128||r[t]===244&&r[t+1]>143||r[t]>244)return!1;t+=4}else return!1;return!0}function zc(r){return Mc&&typeof r=="object"&&typeof r.arrayBuffer=="function"&&typeof r.type=="string"&&typeof r.stream=="function"&&(r[Symbol.toStringTag]==="Blob"||r[Symbol.toStringTag]==="File")}Jt.exports={isBlob:zc,isValidStatusCode:Gc,isValidUTF8:zr,tokenChars:Bc};if(On)Jt.exports.isValidUTF8=function(r){return r.length<24?zr(r):On(r)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let r=require("utf-8-validate");Jt.exports.isValidUTF8=function(e){return e.length<32?zr(e):r(e)}}catch{}});var Kr=E((fp,Wn)=>{"use strict";var{Writable:Xc}=require("stream"),Ln=Et(),{BINARY_TYPES:Hc,EMPTY_BUFFER:An,kStatusCode:Jc,kWebSocket:Yc}=Ee(),{concat:Xr,toArrayBuffer:Kc,unmask:Qc}=gt(),{isValidStatusCode:Zc,isValidUTF8:Fn}=Ye(),Yt=Buffer[Symbol.species],ne=0,Dn=1,Vn=2,qn=3,Hr=4,Jr=5,Kt=6,Yr=class extends Xc{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||Hc[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[Yc]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=ne}_write(e,t,s){if(this._opcode===8&&this._state==ne)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let s=this._buffers[0];return this._buffers[0]=new Yt(s.buffer,s.byteOffset+e,s.length-e),new Yt(s.buffer,s.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let s=this._buffers[0],n=t.length-e;e>=s.length?t.set(this._buffers.shift(),n):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),n),this._buffers[0]=new Yt(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case ne:this.getInfo(e);break;case Dn:this.getPayloadLength16(e);break;case Vn:this.getPayloadLength64(e);break;case qn:this.getMask();break;case Hr:this.getData(e);break;case Jr:case Kt:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if(t[0]&48){let n=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(n);return}let s=(t[0]&64)===64;if(s&&!this._extensions[Ln.extensionName]){let n=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(n);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(s){let n=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(n);return}if(!this._fragmented){let n=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(n);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let n=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(n);return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let n=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(n);return}if(s){let n=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(n);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let n=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(n);return}}else{let n=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(n);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let n=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(n);return}}else if(this._masked){let n=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(n);return}this._payloadLength===126?this._state=Dn:this._payloadLength===127?this._state=Vn:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){let n=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(n);return}this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=qn:this._state=Hr}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=Hr}getData(e){let t=An;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&Qc(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=Jr,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[Ln.extensionName].decompress(e,this._fin,(n,i)=>{if(n)return t(n);if(i.length){if(this._messageLength+=i.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let o=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(o);return}this._fragments.push(i)}this.dataMessage(t),this._state===ne&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=ne;return}let t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let n;this._binaryType==="nodebuffer"?n=Xr(s,t):this._binaryType==="arraybuffer"?n=Kc(Xr(s,t)):this._binaryType==="blob"?n=new Blob(s):n=s,this._allowSynchronousEvents?(this.emit("message",n,!0),this._state=ne):(this._state=Kt,setImmediate(()=>{this.emit("message",n,!0),this._state=ne,this.startLoop(e)}))}else{let n=Xr(s,t);if(!this._skipUTF8Validation&&!Fn(n)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(i);return}this._state===Jr||this._allowSynchronousEvents?(this.emit("message",n,!1),this._state=ne):(this._state=Kt,setImmediate(()=>{this.emit("message",n,!1),this._state=ne,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,An),this.end();else{let s=e.readUInt16BE(0);if(!Zc(s)){let i=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(i);return}let n=new Yt(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Fn(n)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(i);return}this._loop=!1,this.emit("conclude",s,n),this.end()}this._state=ne;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=ne):(this._state=Kt,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=ne,this.startLoop(t)}))}createError(e,t,s,n,i){this._loop=!1,this._errored=!0;let o=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=i,o[Jc]=n,o}};Wn.exports=Yr});var es=E((dp,Mn)=>{"use strict";var{Duplex:hp}=require("stream"),{randomFillSync:el}=require("crypto"),jn=Et(),{EMPTY_BUFFER:tl,kWebSocket:rl,NOOP:sl}=Ee(),{isBlob:Ke,isValidStatusCode:nl}=Ye(),{mask:Un,toBuffer:Oe}=gt(),ie=Symbol("kByteLength"),il=Buffer.alloc(4),Qt=8*1024,Le,Qe=Qt,ue=0,ol=1,al=2,Qr=class r{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=ue,this.onerror=sl,this[rl]=void 0}static frame(e,t){let s,n=!1,i=2,o=!1;t.mask&&(s=t.maskBuffer||il,t.generateMask?t.generateMask(s):(Qe===Qt&&(Le===void 0&&(Le=Buffer.alloc(Qt)),el(Le,0,Qt),Qe=0),s[0]=Le[Qe++],s[1]=Le[Qe++],s[2]=Le[Qe++],s[3]=Le[Qe++]),o=(s[0]|s[1]|s[2]|s[3])===0,i=6);let a;typeof e=="string"?(!t.mask||o)&&t[ie]!==void 0?a=t[ie]:(e=Buffer.from(e),a=e.length):(a=e.length,n=t.mask&&t.readOnly&&!o);let c=a;a>=65536?(i+=8,c=127):a>125&&(i+=2,c=126);let l=Buffer.allocUnsafe(n?a+i:i);return l[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(l[0]|=64),l[1]=c,c===126?l.writeUInt16BE(a,2):c===127&&(l[2]=l[3]=0,l.writeUIntBE(a,4,6)),t.mask?(l[1]|=128,l[i-4]=s[0],l[i-3]=s[1],l[i-2]=s[2],l[i-1]=s[3],o?[l,e]:n?(Un(e,s,l,i,a),[l]):(Un(e,s,e,0,a),[l,e])):[l,e]}close(e,t,s,n){let i;if(e===void 0)i=tl;else{if(typeof e!="number"||!nl(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0);else{let a=Buffer.byteLength(t);if(a>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+a),i.writeUInt16BE(e,0),typeof t=="string"?i.write(t,2):i.set(t,2)}}let o={[ie]:i.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._state!==ue?this.enqueue([this.dispatch,i,!1,o,n]):this.sendFrame(r.frame(i,o),n)}ping(e,t,s){let n,i;if(typeof e=="string"?(n=Buffer.byteLength(e),i=!1):Ke(e)?(n=e.size,i=!1):(e=Oe(e),n=e.length,i=Oe.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[ie]:n,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};Ke(e)?this._state!==ue?this.enqueue([this.getBlobData,e,!1,o,s]):this.getBlobData(e,!1,o,s):this._state!==ue?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(r.frame(e,o),s)}pong(e,t,s){let n,i;if(typeof e=="string"?(n=Buffer.byteLength(e),i=!1):Ke(e)?(n=e.size,i=!1):(e=Oe(e),n=e.length,i=Oe.readOnly),n>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[ie]:n,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};Ke(e)?this._state!==ue?this.enqueue([this.getBlobData,e,!1,o,s]):this.getBlobData(e,!1,o,s):this._state!==ue?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(r.frame(e,o),s)}send(e,t,s){let n=this._extensions[jn.extensionName],i=t.binary?2:1,o=t.compress,a,c;typeof e=="string"?(a=Buffer.byteLength(e),c=!1):Ke(e)?(a=e.size,c=!1):(e=Oe(e),a=e.length,c=Oe.readOnly),this._firstFragment?(this._firstFragment=!1,o&&n&&n.params[n._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(o=a>=n._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0);let l={[ie]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:c,rsv1:o};Ke(e)?this._state!==ue?this.enqueue([this.getBlobData,e,this._compress,l,s]):this.getBlobData(e,this._compress,l,s):this._state!==ue?this.enqueue([this.dispatch,e,this._compress,l,s]):this.dispatch(e,this._compress,l,s)}getBlobData(e,t,s,n){this._bufferedBytes+=s[ie],this._state=al,e.arrayBuffer().then(i=>{if(this._socket.destroyed){let a=new Error("The socket was closed while the blob was being read");process.nextTick(Zr,this,a,n);return}this._bufferedBytes-=s[ie];let o=Oe(i);t?this.dispatch(o,t,s,n):(this._state=ue,this.sendFrame(r.frame(o,s),n),this.dequeue())}).catch(i=>{process.nextTick(cl,this,i,n)})}dispatch(e,t,s,n){if(!t){this.sendFrame(r.frame(e,s),n);return}let i=this._extensions[jn.extensionName];this._bufferedBytes+=s[ie],this._state=ol,i.compress(e,s.fin,(o,a)=>{if(this._socket.destroyed){let c=new Error("The socket was closed while data was being compressed");Zr(this,c,n);return}this._bufferedBytes-=s[ie],this._state=ue,s.readOnly=!1,this.sendFrame(r.frame(a,s),n),this.dequeue()})}dequeue(){for(;this._state===ue&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][ie],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][ie],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};Mn.exports=Qr;function Zr(r,e,t){typeof t=="function"&&t(e);for(let s=0;s<r._queue.length;s++){let n=r._queue[s],i=n[n.length-1];typeof i=="function"&&i(e)}}function cl(r,e,t){Zr(r,e,t),r.onerror(e)}});var Qn=E((pp,Kn)=>{"use strict";var{kForOnEventAttribute:Tt,kListener:ts}=Ee(),Bn=Symbol("kCode"),Gn=Symbol("kData"),zn=Symbol("kError"),Xn=Symbol("kMessage"),Hn=Symbol("kReason"),Ze=Symbol("kTarget"),Jn=Symbol("kType"),Yn=Symbol("kWasClean"),we=class{constructor(e){this[Ze]=null,this[Jn]=e}get target(){return this[Ze]}get type(){return this[Jn]}};Object.defineProperty(we.prototype,"target",{enumerable:!0});Object.defineProperty(we.prototype,"type",{enumerable:!0});var Ae=class extends we{constructor(e,t={}){super(e),this[Bn]=t.code===void 0?0:t.code,this[Hn]=t.reason===void 0?"":t.reason,this[Yn]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[Bn]}get reason(){return this[Hn]}get wasClean(){return this[Yn]}};Object.defineProperty(Ae.prototype,"code",{enumerable:!0});Object.defineProperty(Ae.prototype,"reason",{enumerable:!0});Object.defineProperty(Ae.prototype,"wasClean",{enumerable:!0});var et=class extends we{constructor(e,t={}){super(e),this[zn]=t.error===void 0?null:t.error,this[Xn]=t.message===void 0?"":t.message}get error(){return this[zn]}get message(){return this[Xn]}};Object.defineProperty(et.prototype,"error",{enumerable:!0});Object.defineProperty(et.prototype,"message",{enumerable:!0});var wt=class extends we{constructor(e,t={}){super(e),this[Gn]=t.data===void 0?null:t.data}get data(){return this[Gn]}};Object.defineProperty(wt.prototype,"data",{enumerable:!0});var ll={addEventListener(r,e,t={}){for(let n of this.listeners(r))if(!t[Tt]&&n[ts]===e&&!n[Tt])return;let s;if(r==="message")s=function(i,o){let a=new wt("message",{data:o?i:i.toString()});a[Ze]=this,Zt(e,this,a)};else if(r==="close")s=function(i,o){let a=new Ae("close",{code:i,reason:o.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});a[Ze]=this,Zt(e,this,a)};else if(r==="error")s=function(i){let o=new et("error",{error:i,message:i.message});o[Ze]=this,Zt(e,this,o)};else if(r==="open")s=function(){let i=new we("open");i[Ze]=this,Zt(e,this,i)};else return;s[Tt]=!!t[Tt],s[ts]=e,t.once?this.once(r,s):this.on(r,s)},removeEventListener(r,e){for(let t of this.listeners(r))if(t[ts]===e&&!t[Tt]){this.removeListener(r,t);break}}};Kn.exports={CloseEvent:Ae,ErrorEvent:et,Event:we,EventTarget:ll,MessageEvent:wt};function Zt(r,e,t){typeof r=="object"&&r.handleEvent?r.handleEvent.call(r,t):r.call(e,t)}});var rs=E((mp,Zn)=>{"use strict";var{tokenChars:St}=Ye();function me(r,e,t){r[e]===void 0?r[e]=[t]:r[e].push(t)}function ul(r){let e=Object.create(null),t=Object.create(null),s=!1,n=!1,i=!1,o,a,c=-1,l=-1,f=-1,u=0;for(;u<r.length;u++)if(l=r.charCodeAt(u),o===void 0)if(f===-1&&St[l]===1)c===-1&&(c=u);else if(u!==0&&(l===32||l===9))f===-1&&c!==-1&&(f=u);else if(l===59||l===44){if(c===-1)throw new SyntaxError(`Unexpected character at index ${u}`);f===-1&&(f=u);let p=r.slice(c,f);l===44?(me(e,p,t),t=Object.create(null)):o=p,c=f=-1}else throw new SyntaxError(`Unexpected character at index ${u}`);else if(a===void 0)if(f===-1&&St[l]===1)c===-1&&(c=u);else if(l===32||l===9)f===-1&&c!==-1&&(f=u);else if(l===59||l===44){if(c===-1)throw new SyntaxError(`Unexpected character at index ${u}`);f===-1&&(f=u),me(t,r.slice(c,f),!0),l===44&&(me(e,o,t),t=Object.create(null),o=void 0),c=f=-1}else if(l===61&&c!==-1&&f===-1)a=r.slice(c,u),c=f=-1;else throw new SyntaxError(`Unexpected character at index ${u}`);else if(n){if(St[l]!==1)throw new SyntaxError(`Unexpected character at index ${u}`);c===-1?c=u:s||(s=!0),n=!1}else if(i)if(St[l]===1)c===-1&&(c=u);else if(l===34&&c!==-1)i=!1,f=u;else if(l===92)n=!0;else throw new SyntaxError(`Unexpected character at index ${u}`);else if(l===34&&r.charCodeAt(u-1)===61)i=!0;else if(f===-1&&St[l]===1)c===-1&&(c=u);else if(c!==-1&&(l===32||l===9))f===-1&&(f=u);else if(l===59||l===44){if(c===-1)throw new SyntaxError(`Unexpected character at index ${u}`);f===-1&&(f=u);let p=r.slice(c,f);s&&(p=p.replace(/\\/g,""),s=!1),me(t,a,p),l===44&&(me(e,o,t),t=Object.create(null),o=void 0),a=void 0,c=f=-1}else throw new SyntaxError(`Unexpected character at index ${u}`);if(c===-1||i||l===32||l===9)throw new SyntaxError("Unexpected end of input");f===-1&&(f=u);let d=r.slice(c,f);return o===void 0?me(e,d,t):(a===void 0?me(t,d,!0):s?me(t,a,d.replace(/\\/g,"")):me(t,a,d),me(e,o,t)),e}function fl(r){return Object.keys(r).map(e=>{let t=r[e];return Array.isArray(t)||(t=[t]),t.map(s=>[e].concat(Object.keys(s).map(n=>{let i=s[n];return Array.isArray(i)||(i=[i]),i.map(o=>o===!0?n:`${n}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}Zn.exports={format:fl,parse:ul}});var as=E((yp,fi)=>{"use strict";var hl=require("events"),dl=require("https"),pl=require("http"),ri=require("net"),ml=require("tls"),{randomBytes:gl,createHash:vl}=require("crypto"),{Duplex:gp,Readable:vp}=require("stream"),{URL:ss}=require("url"),Re=Et(),yl=Kr(),El=es(),{isBlob:Tl}=Ye(),{BINARY_TYPES:ei,EMPTY_BUFFER:er,GUID:wl,kForOnEventAttribute:ns,kListener:Sl,kStatusCode:bl,kWebSocket:B,NOOP:si}=Ee(),{EventTarget:{addEventListener:xl,removeEventListener:_l}}=Qn(),{format:Il,parse:Pl}=rs(),{toBuffer:Cl}=gt(),Rl=30*1e3,ni=Symbol("kAborted"),is=[8,13],Se=["CONNECTING","OPEN","CLOSING","CLOSED"],kl=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,D=class r extends hl{constructor(e,t,s){super(),this._binaryType=ei[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=er,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=r.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(s=t,t=[]):t=[t]),ii(this,e,t,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){ei.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){let n=new yl({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation}),i=new El(e,this._extensions,s.generateMask);this._receiver=n,this._sender=i,this._socket=e,n[B]=this,i[B]=this,e[B]=this,n.on("conclude",Ol),n.on("drain",Ll),n.on("error",Al),n.on("message",Fl),n.on("ping",Dl),n.on("pong",Vl),i.onerror=ql,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",ci),e.on("data",rr),e.on("end",li),e.on("error",ui),this._readyState=r.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=r.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[Re.extensionName]&&this._extensions[Re.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=r.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==r.CLOSED){if(this.readyState===r.CONNECTING){re(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===r.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=r.CLOSING,this._sender.close(e,t,!this._isServer,s=>{s||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),ai(this)}}pause(){this.readyState===r.CONNECTING||this.readyState===r.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){os(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||er,t,s)}pong(e,t,s){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){os(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||er,t,s)}resume(){this.readyState===r.CONNECTING||this.readyState===r.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===r.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(s=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==r.OPEN){os(this,e,s);return}let n={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Re.extensionName]||(n.compress=!1),this._sender.send(e||er,n,s)}terminate(){if(this.readyState!==r.CLOSED){if(this.readyState===r.CONNECTING){re(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=r.CLOSING,this._socket.destroy())}}};Object.defineProperty(D,"CONNECTING",{enumerable:!0,value:Se.indexOf("CONNECTING")});Object.defineProperty(D.prototype,"CONNECTING",{enumerable:!0,value:Se.indexOf("CONNECTING")});Object.defineProperty(D,"OPEN",{enumerable:!0,value:Se.indexOf("OPEN")});Object.defineProperty(D.prototype,"OPEN",{enumerable:!0,value:Se.indexOf("OPEN")});Object.defineProperty(D,"CLOSING",{enumerable:!0,value:Se.indexOf("CLOSING")});Object.defineProperty(D.prototype,"CLOSING",{enumerable:!0,value:Se.indexOf("CLOSING")});Object.defineProperty(D,"CLOSED",{enumerable:!0,value:Se.indexOf("CLOSED")});Object.defineProperty(D.prototype,"CLOSED",{enumerable:!0,value:Se.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(r=>{Object.defineProperty(D.prototype,r,{enumerable:!0})});["open","error","close","message"].forEach(r=>{Object.defineProperty(D.prototype,`on${r}`,{enumerable:!0,get(){for(let e of this.listeners(r))if(e[ns])return e[Sl];return null},set(e){for(let t of this.listeners(r))if(t[ns]){this.removeListener(r,t);break}typeof e=="function"&&this.addEventListener(r,e,{[ns]:!0})}})});D.prototype.addEventListener=xl;D.prototype.removeEventListener=_l;fi.exports=D;function ii(r,e,t,s){let n={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:is[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(r._autoPong=n.autoPong,!is.includes(n.protocolVersion))throw new RangeError(`Unsupported protocol version: ${n.protocolVersion} (supported versions: ${is.join(", ")})`);let i;if(e instanceof ss)i=e;else try{i=new ss(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}i.protocol==="http:"?i.protocol="ws:":i.protocol==="https:"&&(i.protocol="wss:"),r._url=i.href;let o=i.protocol==="wss:",a=i.protocol==="ws+unix:",c;if(i.protocol!=="ws:"&&!o&&!a?c=`The URL's protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"`:a&&!i.pathname?c="The URL's pathname is empty":i.hash&&(c="The URL contains a fragment identifier"),c){let v=new SyntaxError(c);if(r._redirects===0)throw v;tr(r,v);return}let l=o?443:80,f=gl(16).toString("base64"),u=o?dl.request:pl.request,d=new Set,p;if(n.createConnection=n.createConnection||(o?$l:Nl),n.defaultPort=n.defaultPort||l,n.port=i.port||l,n.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,n.headers={...n.headers,"Sec-WebSocket-Version":n.protocolVersion,"Sec-WebSocket-Key":f,Connection:"Upgrade",Upgrade:"websocket"},n.path=i.pathname+i.search,n.timeout=n.handshakeTimeout,n.perMessageDeflate&&(p=new Re(n.perMessageDeflate!==!0?n.perMessageDeflate:{},!1,n.maxPayload),n.headers["Sec-WebSocket-Extensions"]=Il({[Re.extensionName]:p.offer()})),t.length){for(let v of t){if(typeof v!="string"||!kl.test(v)||d.has(v))throw new SyntaxError("An invalid or duplicated subprotocol was specified");d.add(v)}n.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(n.origin&&(n.protocolVersion<13?n.headers["Sec-WebSocket-Origin"]=n.origin:n.headers.Origin=n.origin),(i.username||i.password)&&(n.auth=`${i.username}:${i.password}`),a){let v=n.path.split(":");n.socketPath=v[0],n.path=v[1]}let b;if(n.followRedirects){if(r._redirects===0){r._originalIpc=a,r._originalSecure=o,r._originalHostOrSocketPath=a?n.socketPath:i.host;let v=s&&s.headers;if(s={...s,headers:{}},v)for(let[w,I]of Object.entries(v))s.headers[w.toLowerCase()]=I}else if(r.listenerCount("redirect")===0){let v=a?r._originalIpc?n.socketPath===r._originalHostOrSocketPath:!1:r._originalIpc?!1:i.host===r._originalHostOrSocketPath;(!v||r._originalSecure&&!o)&&(delete n.headers.authorization,delete n.headers.cookie,v||delete n.headers.host,n.auth=void 0)}n.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(n.auth).toString("base64")),b=r._req=u(n),r._redirects&&r.emit("redirect",r.url,b)}else b=r._req=u(n);n.timeout&&b.on("timeout",()=>{re(r,b,"Opening handshake has timed out")}),b.on("error",v=>{b===null||b[ni]||(b=r._req=null,tr(r,v))}),b.on("response",v=>{let w=v.headers.location,I=v.statusCode;if(w&&n.followRedirects&&I>=300&&I<400){if(++r._redirects>n.maxRedirects){re(r,b,"Maximum redirects exceeded");return}b.abort();let P;try{P=new ss(w,e)}catch{let R=new SyntaxError(`Invalid URL: ${w}`);tr(r,R);return}ii(r,P,t,s)}else r.emit("unexpected-response",b,v)||re(r,b,`Unexpected server response: ${v.statusCode}`)}),b.on("upgrade",(v,w,I)=>{if(r.emit("upgrade",v),r.readyState!==D.CONNECTING)return;b=r._req=null;let P=v.headers.upgrade;if(P===void 0||P.toLowerCase()!=="websocket"){re(r,w,"Invalid Upgrade header");return}let y=vl("sha1").update(f+wl).digest("base64");if(v.headers["sec-websocket-accept"]!==y){re(r,w,"Invalid Sec-WebSocket-Accept header");return}let R=v.headers["sec-websocket-protocol"],k;if(R!==void 0?d.size?d.has(R)||(k="Server sent an invalid subprotocol"):k="Server sent a subprotocol but none was requested":d.size&&(k="Server sent no subprotocol"),k){re(r,w,k);return}R&&(r._protocol=R);let U=v.headers["sec-websocket-extensions"];if(U!==void 0){if(!p){re(r,w,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let q;try{q=Pl(U)}catch{re(r,w,"Invalid Sec-WebSocket-Extensions header");return}let S=Object.keys(q);if(S.length!==1||S[0]!==Re.extensionName){re(r,w,"Server indicated an extension that was not requested");return}try{p.accept(q[Re.extensionName])}catch{re(r,w,"Invalid Sec-WebSocket-Extensions header");return}r._extensions[Re.extensionName]=p}r.setSocket(w,I,{allowSynchronousEvents:n.allowSynchronousEvents,generateMask:n.generateMask,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation})}),n.finishRequest?n.finishRequest(b,r):b.end()}function tr(r,e){r._readyState=D.CLOSING,r._errorEmitted=!0,r.emit("error",e),r.emitClose()}function Nl(r){return r.path=r.socketPath,ri.connect(r)}function $l(r){return r.path=void 0,!r.servername&&r.servername!==""&&(r.servername=ri.isIP(r.host)?"":r.host),ml.connect(r)}function re(r,e,t){r._readyState=D.CLOSING;let s=new Error(t);Error.captureStackTrace(s,re),e.setHeader?(e[ni]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(tr,r,s)):(e.destroy(s),e.once("error",r.emit.bind(r,"error")),e.once("close",r.emitClose.bind(r)))}function os(r,e,t){if(e){let s=Tl(e)?e.size:Cl(e).length;r._socket?r._sender._bufferedBytes+=s:r._bufferedAmount+=s}if(t){let s=new Error(`WebSocket is not open: readyState ${r.readyState} (${Se[r.readyState]})`);process.nextTick(t,s)}}function Ol(r,e){let t=this[B];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=r,t._socket[B]!==void 0&&(t._socket.removeListener("data",rr),process.nextTick(oi,t._socket),r===1005?t.close():t.close(r,e))}function Ll(){let r=this[B];r.isPaused||r._socket.resume()}function Al(r){let e=this[B];e._socket[B]!==void 0&&(e._socket.removeListener("data",rr),process.nextTick(oi,e._socket),e.close(r[bl])),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",r))}function ti(){this[B].emitClose()}function Fl(r,e){this[B].emit("message",r,e)}function Dl(r){let e=this[B];e._autoPong&&e.pong(r,!this._isServer,si),e.emit("ping",r)}function Vl(r){this[B].emit("pong",r)}function oi(r){r.resume()}function ql(r){let e=this[B];e.readyState!==D.CLOSED&&(e.readyState===D.OPEN&&(e._readyState=D.CLOSING,ai(e)),this._socket.end(),e._errorEmitted||(e._errorEmitted=!0,e.emit("error",r)))}function ai(r){r._closeTimer=setTimeout(r._socket.destroy.bind(r._socket),Rl)}function ci(){let r=this[B];this.removeListener("close",ci),this.removeListener("data",rr),this.removeListener("end",li),r._readyState=D.CLOSING;let e;!this._readableState.endEmitted&&!r._closeFrameReceived&&!r._receiver._writableState.errorEmitted&&(e=r._socket.read())!==null&&r._receiver.write(e),r._receiver.end(),this[B]=void 0,clearTimeout(r._closeTimer),r._receiver._writableState.finished||r._receiver._writableState.errorEmitted?r.emitClose():(r._receiver.on("error",ti),r._receiver.on("finish",ti))}function rr(r){this[B]._receiver.write(r)||this.pause()}function li(){let r=this[B];r._readyState=D.CLOSING,r._receiver.end(),this.end()}function ui(){let r=this[B];this.removeListener("error",ui),this.on("error",si),r&&(r._readyState=D.CLOSING,this.destroy())}});var di=E((Ep,hi)=>{"use strict";var{tokenChars:Wl}=Ye();function jl(r){let e=new Set,t=-1,s=-1,n=0;for(n;n<r.length;n++){let o=r.charCodeAt(n);if(s===-1&&Wl[o]===1)t===-1&&(t=n);else if(n!==0&&(o===32||o===9))s===-1&&t!==-1&&(s=n);else if(o===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${n}`);s===-1&&(s=n);let a=r.slice(t,s);if(e.has(a))throw new SyntaxError(`The "${a}" subprotocol is duplicated`);e.add(a),t=s=-1}else throw new SyntaxError(`Unexpected character at index ${n}`)}if(t===-1||s!==-1)throw new SyntaxError("Unexpected end of input");let i=r.slice(t,n);if(e.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return e.add(i),e}hi.exports={parse:jl}});var Ti=E((wp,Ei)=>{"use strict";var Ul=require("events"),sr=require("http"),{Duplex:Tp}=require("stream"),{createHash:Ml}=require("crypto"),pi=rs(),Fe=Et(),Bl=di(),Gl=as(),{GUID:zl,kWebSocket:Xl}=Ee(),Hl=/^[+/0-9A-Za-z]{22}==$/,mi=0,gi=1,yi=2,cs=class extends Ul{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Gl,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=sr.createServer((s,n)=>{let i=sr.STATUS_CODES[426];n.writeHead(426,{"Content-Length":i.length,"Content-Type":"text/plain"}),n.end(i)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let s=this.emit.bind(this,"connection");this._removeListeners=Jl(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(n,i,o)=>{this.handleUpgrade(n,i,o,s)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=mi}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===yi){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(bt,this);return}if(e&&this.once("close",e),this._state!==gi)if(this._state=gi,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(bt,this):process.nextTick(bt,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{bt(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,n){t.on("error",vi);let i=e.headers["sec-websocket-key"],o=e.headers.upgrade,a=+e.headers["sec-websocket-version"];if(e.method!=="GET"){De(this,e,t,405,"Invalid HTTP method");return}if(o===void 0||o.toLowerCase()!=="websocket"){De(this,e,t,400,"Invalid Upgrade header");return}if(i===void 0||!Hl.test(i)){De(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(a!==8&&a!==13){De(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(e)){xt(t,400);return}let c=e.headers["sec-websocket-protocol"],l=new Set;if(c!==void 0)try{l=Bl.parse(c)}catch{De(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let f=e.headers["sec-websocket-extensions"],u={};if(this.options.perMessageDeflate&&f!==void 0){let d=new Fe(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let p=pi.parse(f);p[Fe.extensionName]&&(d.accept(p[Fe.extensionName]),u[Fe.extensionName]=d)}catch{De(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let d={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(d,(p,b,v,w)=>{if(!p)return xt(t,b||401,v,w);this.completeUpgrade(u,i,l,e,t,s,n)});return}if(!this.options.verifyClient(d))return xt(t,401)}this.completeUpgrade(u,i,l,e,t,s,n)}completeUpgrade(e,t,s,n,i,o,a){if(!i.readable||!i.writable)return i.destroy();if(i[Xl])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>mi)return xt(i,503);let l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Ml("sha1").update(t+zl).digest("base64")}`],f=new this.options.WebSocket(null,void 0,this.options);if(s.size){let u=this.options.handleProtocols?this.options.handleProtocols(s,n):s.values().next().value;u&&(l.push(`Sec-WebSocket-Protocol: ${u}`),f._protocol=u)}if(e[Fe.extensionName]){let u=e[Fe.extensionName].params,d=pi.format({[Fe.extensionName]:[u]});l.push(`Sec-WebSocket-Extensions: ${d}`),f._extensions=e}this.emit("headers",l,n),i.write(l.concat(`\r
`).join(`\r
`)),i.removeListener("error",vi),f.setSocket(i,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(f),f.on("close",()=>{this.clients.delete(f),this._shouldEmitClose&&!this.clients.size&&process.nextTick(bt,this)})),a(f,n)}};Ei.exports=cs;function Jl(r,e){for(let t of Object.keys(e))r.on(t,e[t]);return function(){for(let s of Object.keys(e))r.removeListener(s,e[s])}}function bt(r){r._state=yi,r.emit("close")}function vi(){this.destroy()}function xt(r,e,t,s){t=t||sr.STATUS_CODES[e],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...s},r.once("finish",r.destroy),r.end(`HTTP/1.1 ${e} ${sr.STATUS_CODES[e]}\r
`+Object.keys(s).map(n=>`${n}: ${s[n]}`).join(`\r
`)+`\r
\r
`+t)}function De(r,e,t,s,n){if(r.listenerCount("wsClientError")){let i=new Error(n);Error.captureStackTrace(i,De),r.emit("wsClientError",i,t,e)}else xt(t,s,n)}});var _t=E((Pp,Si)=>{"use strict";var eu="2.0.0",tu=Number.MAX_SAFE_INTEGER||9007199254740991,ru=16,su=250,nu=["major","premajor","minor","preminor","patch","prepatch","prerelease"];Si.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:ru,MAX_SAFE_BUILD_LENGTH:su,MAX_SAFE_INTEGER:tu,RELEASE_TYPES:nu,SEMVER_SPEC_VERSION:eu,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}});var It=E((Cp,bi)=>{"use strict";var iu=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...r)=>console.error("SEMVER",...r):()=>{};bi.exports=iu});var tt=E((be,xi)=>{"use strict";var{MAX_SAFE_COMPONENT_LENGTH:ls,MAX_SAFE_BUILD_LENGTH:ou,MAX_LENGTH:au}=_t(),cu=It();be=xi.exports={};var lu=be.re=[],uu=be.safeRe=[],m=be.src=[],g=be.t={},fu=0,us="[a-zA-Z0-9-]",hu=[["\\s",1],["\\d",au],[us,ou]],du=r=>{for(let[e,t]of hu)r=r.split(`${e}*`).join(`${e}{0,${t}}`).split(`${e}+`).join(`${e}{1,${t}}`);return r},_=(r,e,t)=>{let s=du(e),n=fu++;cu(r,n,e),g[r]=n,m[n]=e,lu[n]=new RegExp(e,t?"g":void 0),uu[n]=new RegExp(s,t?"g":void 0)};_("NUMERICIDENTIFIER","0|[1-9]\\d*");_("NUMERICIDENTIFIERLOOSE","\\d+");_("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${us}*`);_("MAINVERSION",`(${m[g.NUMERICIDENTIFIER]})\\.(${m[g.NUMERICIDENTIFIER]})\\.(${m[g.NUMERICIDENTIFIER]})`);_("MAINVERSIONLOOSE",`(${m[g.NUMERICIDENTIFIERLOOSE]})\\.(${m[g.NUMERICIDENTIFIERLOOSE]})\\.(${m[g.NUMERICIDENTIFIERLOOSE]})`);_("PRERELEASEIDENTIFIER",`(?:${m[g.NUMERICIDENTIFIER]}|${m[g.NONNUMERICIDENTIFIER]})`);_("PRERELEASEIDENTIFIERLOOSE",`(?:${m[g.NUMERICIDENTIFIERLOOSE]}|${m[g.NONNUMERICIDENTIFIER]})`);_("PRERELEASE",`(?:-(${m[g.PRERELEASEIDENTIFIER]}(?:\\.${m[g.PRERELEASEIDENTIFIER]})*))`);_("PRERELEASELOOSE",`(?:-?(${m[g.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${m[g.PRERELEASEIDENTIFIERLOOSE]})*))`);_("BUILDIDENTIFIER",`${us}+`);_("BUILD",`(?:\\+(${m[g.BUILDIDENTIFIER]}(?:\\.${m[g.BUILDIDENTIFIER]})*))`);_("FULLPLAIN",`v?${m[g.MAINVERSION]}${m[g.PRERELEASE]}?${m[g.BUILD]}?`);_("FULL",`^${m[g.FULLPLAIN]}$`);_("LOOSEPLAIN",`[v=\\s]*${m[g.MAINVERSIONLOOSE]}${m[g.PRERELEASELOOSE]}?${m[g.BUILD]}?`);_("LOOSE",`^${m[g.LOOSEPLAIN]}$`);_("GTLT","((?:<|>)?=?)");_("XRANGEIDENTIFIERLOOSE",`${m[g.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`);_("XRANGEIDENTIFIER",`${m[g.NUMERICIDENTIFIER]}|x|X|\\*`);_("XRANGEPLAIN",`[v=\\s]*(${m[g.XRANGEIDENTIFIER]})(?:\\.(${m[g.XRANGEIDENTIFIER]})(?:\\.(${m[g.XRANGEIDENTIFIER]})(?:${m[g.PRERELEASE]})?${m[g.BUILD]}?)?)?`);_("XRANGEPLAINLOOSE",`[v=\\s]*(${m[g.XRANGEIDENTIFIERLOOSE]})(?:\\.(${m[g.XRANGEIDENTIFIERLOOSE]})(?:\\.(${m[g.XRANGEIDENTIFIERLOOSE]})(?:${m[g.PRERELEASELOOSE]})?${m[g.BUILD]}?)?)?`);_("XRANGE",`^${m[g.GTLT]}\\s*${m[g.XRANGEPLAIN]}$`);_("XRANGELOOSE",`^${m[g.GTLT]}\\s*${m[g.XRANGEPLAINLOOSE]}$`);_("COERCEPLAIN",`(^|[^\\d])(\\d{1,${ls}})(?:\\.(\\d{1,${ls}}))?(?:\\.(\\d{1,${ls}}))?`);_("COERCE",`${m[g.COERCEPLAIN]}(?:$|[^\\d])`);_("COERCEFULL",m[g.COERCEPLAIN]+`(?:${m[g.PRERELEASE]})?(?:${m[g.BUILD]})?(?:$|[^\\d])`);_("COERCERTL",m[g.COERCE],!0);_("COERCERTLFULL",m[g.COERCEFULL],!0);_("LONETILDE","(?:~>?)");_("TILDETRIM",`(\\s*)${m[g.LONETILDE]}\\s+`,!0);be.tildeTrimReplace="$1~";_("TILDE",`^${m[g.LONETILDE]}${m[g.XRANGEPLAIN]}$`);_("TILDELOOSE",`^${m[g.LONETILDE]}${m[g.XRANGEPLAINLOOSE]}$`);_("LONECARET","(?:\\^)");_("CARETTRIM",`(\\s*)${m[g.LONECARET]}\\s+`,!0);be.caretTrimReplace="$1^";_("CARET",`^${m[g.LONECARET]}${m[g.XRANGEPLAIN]}$`);_("CARETLOOSE",`^${m[g.LONECARET]}${m[g.XRANGEPLAINLOOSE]}$`);_("COMPARATORLOOSE",`^${m[g.GTLT]}\\s*(${m[g.LOOSEPLAIN]})$|^$`);_("COMPARATOR",`^${m[g.GTLT]}\\s*(${m[g.FULLPLAIN]})$|^$`);_("COMPARATORTRIM",`(\\s*)${m[g.GTLT]}\\s*(${m[g.LOOSEPLAIN]}|${m[g.XRANGEPLAIN]})`,!0);be.comparatorTrimReplace="$1$2$3";_("HYPHENRANGE",`^\\s*(${m[g.XRANGEPLAIN]})\\s+-\\s+(${m[g.XRANGEPLAIN]})\\s*$`);_("HYPHENRANGELOOSE",`^\\s*(${m[g.XRANGEPLAINLOOSE]})\\s+-\\s+(${m[g.XRANGEPLAINLOOSE]})\\s*$`);_("STAR","(<|>)?=?\\s*\\*");_("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$");_("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")});var ar=E((Rp,_i)=>{"use strict";var pu=Object.freeze({loose:!0}),mu=Object.freeze({}),gu=r=>r?typeof r!="object"?pu:r:mu;_i.exports=gu});var fs=E((kp,Ci)=>{"use strict";var Ii=/^[0-9]+$/,Pi=(r,e)=>{let t=Ii.test(r),s=Ii.test(e);return t&&s&&(r=+r,e=+e),r===e?0:t&&!s?-1:s&&!t?1:r<e?-1:1},vu=(r,e)=>Pi(e,r);Ci.exports={compareIdentifiers:Pi,rcompareIdentifiers:vu}});var X=E((Np,$i)=>{"use strict";var cr=It(),{MAX_LENGTH:Ri,MAX_SAFE_INTEGER:lr}=_t(),{safeRe:ki,t:Ni}=tt(),yu=ar(),{compareIdentifiers:rt}=fs(),hs=class r{constructor(e,t){if(t=yu(t),e instanceof r){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Ri)throw new TypeError(`version is longer than ${Ri} characters`);cr("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;let s=e.trim().match(t.loose?ki[Ni.LOOSE]:ki[Ni.FULL]);if(!s)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+s[1],this.minor=+s[2],this.patch=+s[3],this.major>lr||this.major<0)throw new TypeError("Invalid major version");if(this.minor>lr||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>lr||this.patch<0)throw new TypeError("Invalid patch version");s[4]?this.prerelease=s[4].split(".").map(n=>{if(/^[0-9]+$/.test(n)){let i=+n;if(i>=0&&i<lr)return i}return n}):this.prerelease=[],this.build=s[5]?s[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(cr("SemVer.compare",this.version,this.options,e),!(e instanceof r)){if(typeof e=="string"&&e===this.version)return 0;e=new r(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof r||(e=new r(e,this.options)),rt(this.major,e.major)||rt(this.minor,e.minor)||rt(this.patch,e.patch)}comparePre(e){if(e instanceof r||(e=new r(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{let s=this.prerelease[t],n=e.prerelease[t];if(cr("prerelease compare",t,s,n),s===void 0&&n===void 0)return 0;if(n===void 0)return 1;if(s===void 0)return-1;if(s===n)continue;return rt(s,n)}while(++t)}compareBuild(e){e instanceof r||(e=new r(e,this.options));let t=0;do{let s=this.build[t],n=e.build[t];if(cr("prerelease compare",t,s,n),s===void 0&&n===void 0)return 0;if(n===void 0)return 1;if(s===void 0)return-1;if(s===n)continue;return rt(s,n)}while(++t)}inc(e,t,s){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,s);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,s);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,s),this.inc("pre",t,s);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,s),this.inc("pre",t,s);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{let n=Number(s)?1:0;if(!t&&s===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[n];else{let i=this.prerelease.length;for(;--i>=0;)typeof this.prerelease[i]=="number"&&(this.prerelease[i]++,i=-2);if(i===-1){if(t===this.prerelease.join(".")&&s===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(n)}}if(t){let i=[t,n];s===!1&&(i=[t]),rt(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=i):this.prerelease=i}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};$i.exports=hs});var qe=E(($p,Li)=>{"use strict";var Oi=X(),Eu=(r,e,t=!1)=>{if(r instanceof Oi)return r;try{return new Oi(r,e)}catch(s){if(!t)return null;throw s}};Li.exports=Eu});var Fi=E((Op,Ai)=>{"use strict";var Tu=qe(),wu=(r,e)=>{let t=Tu(r,e);return t?t.version:null};Ai.exports=wu});var Vi=E((Lp,Di)=>{"use strict";var Su=qe(),bu=(r,e)=>{let t=Su(r.trim().replace(/^[=v]+/,""),e);return t?t.version:null};Di.exports=bu});var ji=E((Ap,Wi)=>{"use strict";var qi=X(),xu=(r,e,t,s,n)=>{typeof t=="string"&&(n=s,s=t,t=void 0);try{return new qi(r instanceof qi?r.version:r,t).inc(e,s,n).version}catch{return null}};Wi.exports=xu});var Bi=E((Fp,Mi)=>{"use strict";var Ui=qe(),_u=(r,e)=>{let t=Ui(r,null,!0),s=Ui(e,null,!0),n=t.compare(s);if(n===0)return null;let i=n>0,o=i?t:s,a=i?s:t,c=!!o.prerelease.length;if(!!a.prerelease.length&&!c)return!a.patch&&!a.minor?"major":o.patch?"patch":o.minor?"minor":"major";let f=c?"pre":"";return t.major!==s.major?f+"major":t.minor!==s.minor?f+"minor":t.patch!==s.patch?f+"patch":"prerelease"};Mi.exports=_u});var zi=E((Dp,Gi)=>{"use strict";var Iu=X(),Pu=(r,e)=>new Iu(r,e).major;Gi.exports=Pu});var Hi=E((Vp,Xi)=>{"use strict";var Cu=X(),Ru=(r,e)=>new Cu(r,e).minor;Xi.exports=Ru});var Yi=E((qp,Ji)=>{"use strict";var ku=X(),Nu=(r,e)=>new ku(r,e).patch;Ji.exports=Nu});var Qi=E((Wp,Ki)=>{"use strict";var $u=qe(),Ou=(r,e)=>{let t=$u(r,e);return t&&t.prerelease.length?t.prerelease:null};Ki.exports=Ou});var oe=E((jp,eo)=>{"use strict";var Zi=X(),Lu=(r,e,t)=>new Zi(r,t).compare(new Zi(e,t));eo.exports=Lu});var ro=E((Up,to)=>{"use strict";var Au=oe(),Fu=(r,e,t)=>Au(e,r,t);to.exports=Fu});var no=E((Mp,so)=>{"use strict";var Du=oe(),Vu=(r,e)=>Du(r,e,!0);so.exports=Vu});var ur=E((Bp,oo)=>{"use strict";var io=X(),qu=(r,e,t)=>{let s=new io(r,t),n=new io(e,t);return s.compare(n)||s.compareBuild(n)};oo.exports=qu});var co=E((Gp,ao)=>{"use strict";var Wu=ur(),ju=(r,e)=>r.sort((t,s)=>Wu(t,s,e));ao.exports=ju});var uo=E((zp,lo)=>{"use strict";var Uu=ur(),Mu=(r,e)=>r.sort((t,s)=>Uu(s,t,e));lo.exports=Mu});var Pt=E((Xp,fo)=>{"use strict";var Bu=oe(),Gu=(r,e,t)=>Bu(r,e,t)>0;fo.exports=Gu});var fr=E((Hp,ho)=>{"use strict";var zu=oe(),Xu=(r,e,t)=>zu(r,e,t)<0;ho.exports=Xu});var ds=E((Jp,po)=>{"use strict";var Hu=oe(),Ju=(r,e,t)=>Hu(r,e,t)===0;po.exports=Ju});var ps=E((Yp,mo)=>{"use strict";var Yu=oe(),Ku=(r,e,t)=>Yu(r,e,t)!==0;mo.exports=Ku});var hr=E((Kp,go)=>{"use strict";var Qu=oe(),Zu=(r,e,t)=>Qu(r,e,t)>=0;go.exports=Zu});var dr=E((Qp,vo)=>{"use strict";var ef=oe(),tf=(r,e,t)=>ef(r,e,t)<=0;vo.exports=tf});var ms=E((Zp,yo)=>{"use strict";var rf=ds(),sf=ps(),nf=Pt(),of=hr(),af=fr(),cf=dr(),lf=(r,e,t,s)=>{switch(e){case"===":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r===t;case"!==":return typeof r=="object"&&(r=r.version),typeof t=="object"&&(t=t.version),r!==t;case"":case"=":case"==":return rf(r,t,s);case"!=":return sf(r,t,s);case">":return nf(r,t,s);case">=":return of(r,t,s);case"<":return af(r,t,s);case"<=":return cf(r,t,s);default:throw new TypeError(`Invalid operator: ${e}`)}};yo.exports=lf});var To=E((em,Eo)=>{"use strict";var uf=X(),ff=qe(),{safeRe:pr,t:mr}=tt(),hf=(r,e)=>{if(r instanceof uf)return r;if(typeof r=="number"&&(r=String(r)),typeof r!="string")return null;e=e||{};let t=null;if(!e.rtl)t=r.match(e.includePrerelease?pr[mr.COERCEFULL]:pr[mr.COERCE]);else{let c=e.includePrerelease?pr[mr.COERCERTLFULL]:pr[mr.COERCERTL],l;for(;(l=c.exec(r))&&(!t||t.index+t[0].length!==r.length);)(!t||l.index+l[0].length!==t.index+t[0].length)&&(t=l),c.lastIndex=l.index+l[1].length+l[2].length;c.lastIndex=-1}if(t===null)return null;let s=t[2],n=t[3]||"0",i=t[4]||"0",o=e.includePrerelease&&t[5]?`-${t[5]}`:"",a=e.includePrerelease&&t[6]?`+${t[6]}`:"";return ff(`${s}.${n}.${i}${o}${a}`,e)};Eo.exports=hf});var So=E((tm,wo)=>{"use strict";wo.exports=function(r){r.prototype[Symbol.iterator]=function*(){for(let e=this.head;e;e=e.next)yield e.value}}});var xo=E((rm,bo)=>{"use strict";bo.exports=$;$.Node=We;$.create=$;function $(r){var e=this;if(e instanceof $||(e=new $),e.tail=null,e.head=null,e.length=0,r&&typeof r.forEach=="function")r.forEach(function(n){e.push(n)});else if(arguments.length>0)for(var t=0,s=arguments.length;t<s;t++)e.push(arguments[t]);return e}$.prototype.removeNode=function(r){if(r.list!==this)throw new Error("removing node which does not belong to this list");var e=r.next,t=r.prev;return e&&(e.prev=t),t&&(t.next=e),r===this.head&&(this.head=e),r===this.tail&&(this.tail=t),r.list.length--,r.next=null,r.prev=null,r.list=null,e};$.prototype.unshiftNode=function(r){if(r!==this.head){r.list&&r.list.removeNode(r);var e=this.head;r.list=this,r.next=e,e&&(e.prev=r),this.head=r,this.tail||(this.tail=r),this.length++}};$.prototype.pushNode=function(r){if(r!==this.tail){r.list&&r.list.removeNode(r);var e=this.tail;r.list=this,r.prev=e,e&&(e.next=r),this.tail=r,this.head||(this.head=r),this.length++}};$.prototype.push=function(){for(var r=0,e=arguments.length;r<e;r++)pf(this,arguments[r]);return this.length};$.prototype.unshift=function(){for(var r=0,e=arguments.length;r<e;r++)mf(this,arguments[r]);return this.length};$.prototype.pop=function(){if(this.tail){var r=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,r}};$.prototype.shift=function(){if(this.head){var r=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,r}};$.prototype.forEach=function(r,e){e=e||this;for(var t=this.head,s=0;t!==null;s++)r.call(e,t.value,s,this),t=t.next};$.prototype.forEachReverse=function(r,e){e=e||this;for(var t=this.tail,s=this.length-1;t!==null;s--)r.call(e,t.value,s,this),t=t.prev};$.prototype.get=function(r){for(var e=0,t=this.head;t!==null&&e<r;e++)t=t.next;if(e===r&&t!==null)return t.value};$.prototype.getReverse=function(r){for(var e=0,t=this.tail;t!==null&&e<r;e++)t=t.prev;if(e===r&&t!==null)return t.value};$.prototype.map=function(r,e){e=e||this;for(var t=new $,s=this.head;s!==null;)t.push(r.call(e,s.value,this)),s=s.next;return t};$.prototype.mapReverse=function(r,e){e=e||this;for(var t=new $,s=this.tail;s!==null;)t.push(r.call(e,s.value,this)),s=s.prev;return t};$.prototype.reduce=function(r,e){var t,s=this.head;if(arguments.length>1)t=e;else if(this.head)s=this.head.next,t=this.head.value;else throw new TypeError("Reduce of empty list with no initial value");for(var n=0;s!==null;n++)t=r(t,s.value,n),s=s.next;return t};$.prototype.reduceReverse=function(r,e){var t,s=this.tail;if(arguments.length>1)t=e;else if(this.tail)s=this.tail.prev,t=this.tail.value;else throw new TypeError("Reduce of empty list with no initial value");for(var n=this.length-1;s!==null;n--)t=r(t,s.value,n),s=s.prev;return t};$.prototype.toArray=function(){for(var r=new Array(this.length),e=0,t=this.head;t!==null;e++)r[e]=t.value,t=t.next;return r};$.prototype.toArrayReverse=function(){for(var r=new Array(this.length),e=0,t=this.tail;t!==null;e++)r[e]=t.value,t=t.prev;return r};$.prototype.slice=function(r,e){e=e||this.length,e<0&&(e+=this.length),r=r||0,r<0&&(r+=this.length);var t=new $;if(e<r||e<0)return t;r<0&&(r=0),e>this.length&&(e=this.length);for(var s=0,n=this.head;n!==null&&s<r;s++)n=n.next;for(;n!==null&&s<e;s++,n=n.next)t.push(n.value);return t};$.prototype.sliceReverse=function(r,e){e=e||this.length,e<0&&(e+=this.length),r=r||0,r<0&&(r+=this.length);var t=new $;if(e<r||e<0)return t;r<0&&(r=0),e>this.length&&(e=this.length);for(var s=this.length,n=this.tail;n!==null&&s>e;s--)n=n.prev;for(;n!==null&&s>r;s--,n=n.prev)t.push(n.value);return t};$.prototype.splice=function(r,e,...t){r>this.length&&(r=this.length-1),r<0&&(r=this.length+r);for(var s=0,n=this.head;n!==null&&s<r;s++)n=n.next;for(var i=[],s=0;n&&s<e;s++)i.push(n.value),n=this.removeNode(n);n===null&&(n=this.tail),n!==this.head&&n!==this.tail&&(n=n.prev);for(var s=0;s<t.length;s++)n=df(this,n,t[s]);return i};$.prototype.reverse=function(){for(var r=this.head,e=this.tail,t=r;t!==null;t=t.prev){var s=t.prev;t.prev=t.next,t.next=s}return this.head=e,this.tail=r,this};function df(r,e,t){var s=e===r.head?new We(t,null,e,r):new We(t,e,e.next,r);return s.next===null&&(r.tail=s),s.prev===null&&(r.head=s),r.length++,s}function pf(r,e){r.tail=new We(e,r.tail,null,r),r.head||(r.head=r.tail),r.length++}function mf(r,e){r.head=new We(e,null,r.head,r),r.tail||(r.tail=r.head),r.length++}function We(r,e,t,s){if(!(this instanceof We))return new We(r,e,t,s);this.list=s,this.value=r,e?(e.next=this,this.prev=e):this.prev=null,t?(t.prev=this,this.next=t):this.next=null}try{So()($)}catch{}});var Ro=E((sm,Co)=>{"use strict";var gf=xo(),je=Symbol("max"),_e=Symbol("length"),st=Symbol("lengthCalculator"),Rt=Symbol("allowStale"),Ue=Symbol("maxAge"),xe=Symbol("dispose"),_o=Symbol("noDisposeOnSet"),G=Symbol("lruList"),fe=Symbol("cache"),Po=Symbol("updateAgeOnGet"),gs=()=>1,ys=class{constructor(e){if(typeof e=="number"&&(e={max:e}),e||(e={}),e.max&&(typeof e.max!="number"||e.max<0))throw new TypeError("max must be a non-negative number");let t=this[je]=e.max||1/0,s=e.length||gs;if(this[st]=typeof s!="function"?gs:s,this[Rt]=e.stale||!1,e.maxAge&&typeof e.maxAge!="number")throw new TypeError("maxAge must be a number");this[Ue]=e.maxAge||0,this[xe]=e.dispose,this[_o]=e.noDisposeOnSet||!1,this[Po]=e.updateAgeOnGet||!1,this.reset()}set max(e){if(typeof e!="number"||e<0)throw new TypeError("max must be a non-negative number");this[je]=e||1/0,Ct(this)}get max(){return this[je]}set allowStale(e){this[Rt]=!!e}get allowStale(){return this[Rt]}set maxAge(e){if(typeof e!="number")throw new TypeError("maxAge must be a non-negative number");this[Ue]=e,Ct(this)}get maxAge(){return this[Ue]}set lengthCalculator(e){typeof e!="function"&&(e=gs),e!==this[st]&&(this[st]=e,this[_e]=0,this[G].forEach(t=>{t.length=this[st](t.value,t.key),this[_e]+=t.length})),Ct(this)}get lengthCalculator(){return this[st]}get length(){return this[_e]}get itemCount(){return this[G].length}rforEach(e,t){t=t||this;for(let s=this[G].tail;s!==null;){let n=s.prev;Io(this,e,s,t),s=n}}forEach(e,t){t=t||this;for(let s=this[G].head;s!==null;){let n=s.next;Io(this,e,s,t),s=n}}keys(){return this[G].toArray().map(e=>e.key)}values(){return this[G].toArray().map(e=>e.value)}reset(){this[xe]&&this[G]&&this[G].length&&this[G].forEach(e=>this[xe](e.key,e.value)),this[fe]=new Map,this[G]=new gf,this[_e]=0}dump(){return this[G].map(e=>gr(this,e)?!1:{k:e.key,v:e.value,e:e.now+(e.maxAge||0)}).toArray().filter(e=>e)}dumpLru(){return this[G]}set(e,t,s){if(s=s||this[Ue],s&&typeof s!="number")throw new TypeError("maxAge must be a number");let n=s?Date.now():0,i=this[st](t,e);if(this[fe].has(e)){if(i>this[je])return nt(this,this[fe].get(e)),!1;let c=this[fe].get(e).value;return this[xe]&&(this[_o]||this[xe](e,c.value)),c.now=n,c.maxAge=s,c.value=t,this[_e]+=i-c.length,c.length=i,this.get(e),Ct(this),!0}let o=new Es(e,t,i,n,s);return o.length>this[je]?(this[xe]&&this[xe](e,t),!1):(this[_e]+=o.length,this[G].unshift(o),this[fe].set(e,this[G].head),Ct(this),!0)}has(e){if(!this[fe].has(e))return!1;let t=this[fe].get(e).value;return!gr(this,t)}get(e){return vs(this,e,!0)}peek(e){return vs(this,e,!1)}pop(){let e=this[G].tail;return e?(nt(this,e),e.value):null}del(e){nt(this,this[fe].get(e))}load(e){this.reset();let t=Date.now();for(let s=e.length-1;s>=0;s--){let n=e[s],i=n.e||0;if(i===0)this.set(n.k,n.v);else{let o=i-t;o>0&&this.set(n.k,n.v,o)}}}prune(){this[fe].forEach((e,t)=>vs(this,t,!1))}},vs=(r,e,t)=>{let s=r[fe].get(e);if(s){let n=s.value;if(gr(r,n)){if(nt(r,s),!r[Rt])return}else t&&(r[Po]&&(s.value.now=Date.now()),r[G].unshiftNode(s));return n.value}},gr=(r,e)=>{if(!e||!e.maxAge&&!r[Ue])return!1;let t=Date.now()-e.now;return e.maxAge?t>e.maxAge:r[Ue]&&t>r[Ue]},Ct=r=>{if(r[_e]>r[je])for(let e=r[G].tail;r[_e]>r[je]&&e!==null;){let t=e.prev;nt(r,e),e=t}},nt=(r,e)=>{if(e){let t=e.value;r[xe]&&r[xe](t.key,t.value),r[_e]-=t.length,r[fe].delete(t.key),r[G].removeNode(e)}},Es=class{constructor(e,t,s,n,i){this.key=e,this.value=t,this.length=s,this.now=n,this.maxAge=i||0}},Io=(r,e,t,s)=>{let n=t.value;gr(r,n)&&(nt(r,t),r[Rt]||(n=void 0)),n&&e.call(s,n.value,n.key,r)};Co.exports=ys});var ae=E((nm,Oo)=>{"use strict";var Ts=class r{constructor(e,t){if(t=yf(t),e instanceof r)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new r(e.raw,t);if(e instanceof ws)return this.raw=e.value,this.set=[[e]],this.format(),this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().split(/\s+/).join(" "),this.set=this.raw.split("||").map(s=>this.parseRange(s.trim())).filter(s=>s.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let s=this.set[0];if(this.set=this.set.filter(n=>!No(n[0])),this.set.length===0)this.set=[s];else if(this.set.length>1){for(let n of this.set)if(n.length===1&&_f(n[0])){this.set=[n];break}}}this.format()}format(){return this.range=this.set.map(e=>e.join(" ").trim()).join("||").trim(),this.range}toString(){return this.range}parseRange(e){let s=((this.options.includePrerelease&&bf)|(this.options.loose&&xf))+":"+e,n=ko.get(s);if(n)return n;let i=this.options.loose,o=i?Q[J.HYPHENRANGELOOSE]:Q[J.HYPHENRANGE];e=e.replace(o,Af(this.options.includePrerelease)),F("hyphen replace",e),e=e.replace(Q[J.COMPARATORTRIM],Tf),F("comparator trim",e),e=e.replace(Q[J.TILDETRIM],wf),F("tilde trim",e),e=e.replace(Q[J.CARETTRIM],Sf),F("caret trim",e);let a=e.split(" ").map(u=>If(u,this.options)).join(" ").split(/\s+/).map(u=>Lf(u,this.options));i&&(a=a.filter(u=>(F("loose invalid filter",u,this.options),!!u.match(Q[J.COMPARATORLOOSE])))),F("range list",a);let c=new Map,l=a.map(u=>new ws(u,this.options));for(let u of l){if(No(u))return[u];c.set(u.value,u)}c.size>1&&c.has("")&&c.delete("");let f=[...c.values()];return ko.set(s,f),f}intersects(e,t){if(!(e instanceof r))throw new TypeError("a Range is required");return this.set.some(s=>$o(s,t)&&e.set.some(n=>$o(n,t)&&s.every(i=>n.every(o=>i.intersects(o,t)))))}test(e){if(!e)return!1;if(typeof e=="string")try{e=new Ef(e,this.options)}catch{return!1}for(let t=0;t<this.set.length;t++)if(Ff(this.set[t],e,this.options))return!0;return!1}};Oo.exports=Ts;var vf=Ro(),ko=new vf({max:1e3}),yf=ar(),ws=kt(),F=It(),Ef=X(),{safeRe:Q,t:J,comparatorTrimReplace:Tf,tildeTrimReplace:wf,caretTrimReplace:Sf}=tt(),{FLAG_INCLUDE_PRERELEASE:bf,FLAG_LOOSE:xf}=_t(),No=r=>r.value==="<0.0.0-0",_f=r=>r.value==="",$o=(r,e)=>{let t=!0,s=r.slice(),n=s.pop();for(;t&&s.length;)t=s.every(i=>n.intersects(i,e)),n=s.pop();return t},If=(r,e)=>(F("comp",r,e),r=Rf(r,e),F("caret",r),r=Pf(r,e),F("tildes",r),r=Nf(r,e),F("xrange",r),r=Of(r,e),F("stars",r),r),Y=r=>!r||r.toLowerCase()==="x"||r==="*",Pf=(r,e)=>r.trim().split(/\s+/).map(t=>Cf(t,e)).join(" "),Cf=(r,e)=>{let t=e.loose?Q[J.TILDELOOSE]:Q[J.TILDE];return r.replace(t,(s,n,i,o,a)=>{F("tilde",r,s,n,i,o,a);let c;return Y(n)?c="":Y(i)?c=`>=${n}.0.0 <${+n+1}.0.0-0`:Y(o)?c=`>=${n}.${i}.0 <${n}.${+i+1}.0-0`:a?(F("replaceTilde pr",a),c=`>=${n}.${i}.${o}-${a} <${n}.${+i+1}.0-0`):c=`>=${n}.${i}.${o} <${n}.${+i+1}.0-0`,F("tilde return",c),c})},Rf=(r,e)=>r.trim().split(/\s+/).map(t=>kf(t,e)).join(" "),kf=(r,e)=>{F("caret",r,e);let t=e.loose?Q[J.CARETLOOSE]:Q[J.CARET],s=e.includePrerelease?"-0":"";return r.replace(t,(n,i,o,a,c)=>{F("caret",r,n,i,o,a,c);let l;return Y(i)?l="":Y(o)?l=`>=${i}.0.0${s} <${+i+1}.0.0-0`:Y(a)?i==="0"?l=`>=${i}.${o}.0${s} <${i}.${+o+1}.0-0`:l=`>=${i}.${o}.0${s} <${+i+1}.0.0-0`:c?(F("replaceCaret pr",c),i==="0"?o==="0"?l=`>=${i}.${o}.${a}-${c} <${i}.${o}.${+a+1}-0`:l=`>=${i}.${o}.${a}-${c} <${i}.${+o+1}.0-0`:l=`>=${i}.${o}.${a}-${c} <${+i+1}.0.0-0`):(F("no pr"),i==="0"?o==="0"?l=`>=${i}.${o}.${a}${s} <${i}.${o}.${+a+1}-0`:l=`>=${i}.${o}.${a}${s} <${i}.${+o+1}.0-0`:l=`>=${i}.${o}.${a} <${+i+1}.0.0-0`),F("caret return",l),l})},Nf=(r,e)=>(F("replaceXRanges",r,e),r.split(/\s+/).map(t=>$f(t,e)).join(" ")),$f=(r,e)=>{r=r.trim();let t=e.loose?Q[J.XRANGELOOSE]:Q[J.XRANGE];return r.replace(t,(s,n,i,o,a,c)=>{F("xRange",r,s,n,i,o,a,c);let l=Y(i),f=l||Y(o),u=f||Y(a),d=u;return n==="="&&d&&(n=""),c=e.includePrerelease?"-0":"",l?n===">"||n==="<"?s="<0.0.0-0":s="*":n&&d?(f&&(o=0),a=0,n===">"?(n=">=",f?(i=+i+1,o=0,a=0):(o=+o+1,a=0)):n==="<="&&(n="<",f?i=+i+1:o=+o+1),n==="<"&&(c="-0"),s=`${n+i}.${o}.${a}${c}`):f?s=`>=${i}.0.0${c} <${+i+1}.0.0-0`:u&&(s=`>=${i}.${o}.0${c} <${i}.${+o+1}.0-0`),F("xRange return",s),s})},Of=(r,e)=>(F("replaceStars",r,e),r.trim().replace(Q[J.STAR],"")),Lf=(r,e)=>(F("replaceGTE0",r,e),r.trim().replace(Q[e.includePrerelease?J.GTE0PRE:J.GTE0],"")),Af=r=>(e,t,s,n,i,o,a,c,l,f,u,d,p)=>(Y(s)?t="":Y(n)?t=`>=${s}.0.0${r?"-0":""}`:Y(i)?t=`>=${s}.${n}.0${r?"-0":""}`:o?t=`>=${t}`:t=`>=${t}${r?"-0":""}`,Y(l)?c="":Y(f)?c=`<${+l+1}.0.0-0`:Y(u)?c=`<${l}.${+f+1}.0-0`:d?c=`<=${l}.${f}.${u}-${d}`:r?c=`<${l}.${f}.${+u+1}-0`:c=`<=${c}`,`${t} ${c}`.trim()),Ff=(r,e,t)=>{for(let s=0;s<r.length;s++)if(!r[s].test(e))return!1;if(e.prerelease.length&&!t.includePrerelease){for(let s=0;s<r.length;s++)if(F(r[s].semver),r[s].semver!==ws.ANY&&r[s].semver.prerelease.length>0){let n=r[s].semver;if(n.major===e.major&&n.minor===e.minor&&n.patch===e.patch)return!0}return!1}return!0}});var kt=E((im,qo)=>{"use strict";var Nt=Symbol("SemVer ANY"),xs=class r{static get ANY(){return Nt}constructor(e,t){if(t=Lo(t),e instanceof r){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),bs("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===Nt?this.value="":this.value=this.operator+this.semver.version,bs("comp",this)}parse(e){let t=this.options.loose?Ao[Fo.COMPARATORLOOSE]:Ao[Fo.COMPARATOR],s=e.match(t);if(!s)throw new TypeError(`Invalid comparator: ${e}`);this.operator=s[1]!==void 0?s[1]:"",this.operator==="="&&(this.operator=""),s[2]?this.semver=new Do(s[2],this.options.loose):this.semver=Nt}toString(){return this.value}test(e){if(bs("Comparator.test",e,this.options.loose),this.semver===Nt||e===Nt)return!0;if(typeof e=="string")try{e=new Do(e,this.options)}catch{return!1}return Ss(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof r))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new Vo(e.value,t).test(this.value):e.operator===""?e.value===""?!0:new Vo(this.value,t).test(e.semver):(t=Lo(t),t.includePrerelease&&(this.value==="<0.0.0-0"||e.value==="<0.0.0-0")||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||Ss(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||Ss(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}};qo.exports=xs;var Lo=ar(),{safeRe:Ao,t:Fo}=tt(),Ss=ms(),bs=It(),Do=X(),Vo=ae()});var $t=E((om,Wo)=>{"use strict";var Df=ae(),Vf=(r,e,t)=>{try{e=new Df(e,t)}catch{return!1}return e.test(r)};Wo.exports=Vf});var Uo=E((am,jo)=>{"use strict";var qf=ae(),Wf=(r,e)=>new qf(r,e).set.map(t=>t.map(s=>s.value).join(" ").trim().split(" "));jo.exports=Wf});var Bo=E((cm,Mo)=>{"use strict";var jf=X(),Uf=ae(),Mf=(r,e,t)=>{let s=null,n=null,i=null;try{i=new Uf(e,t)}catch{return null}return r.forEach(o=>{i.test(o)&&(!s||n.compare(o)===-1)&&(s=o,n=new jf(s,t))}),s};Mo.exports=Mf});var zo=E((lm,Go)=>{"use strict";var Bf=X(),Gf=ae(),zf=(r,e,t)=>{let s=null,n=null,i=null;try{i=new Gf(e,t)}catch{return null}return r.forEach(o=>{i.test(o)&&(!s||n.compare(o)===1)&&(s=o,n=new Bf(s,t))}),s};Go.exports=zf});var Jo=E((um,Ho)=>{"use strict";var _s=X(),Xf=ae(),Xo=Pt(),Hf=(r,e)=>{r=new Xf(r,e);let t=new _s("0.0.0");if(r.test(t)||(t=new _s("0.0.0-0"),r.test(t)))return t;t=null;for(let s=0;s<r.set.length;++s){let n=r.set[s],i=null;n.forEach(o=>{let a=new _s(o.semver.version);switch(o.operator){case">":a.prerelease.length===0?a.patch++:a.prerelease.push(0),a.raw=a.format();case"":case">=":(!i||Xo(a,i))&&(i=a);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${o.operator}`)}}),i&&(!t||Xo(t,i))&&(t=i)}return t&&r.test(t)?t:null};Ho.exports=Hf});var Ko=E((fm,Yo)=>{"use strict";var Jf=ae(),Yf=(r,e)=>{try{return new Jf(r,e).range||"*"}catch{return null}};Yo.exports=Yf});var vr=E((hm,ta)=>{"use strict";var Kf=X(),ea=kt(),{ANY:Qf}=ea,Zf=ae(),eh=$t(),Qo=Pt(),Zo=fr(),th=dr(),rh=hr(),sh=(r,e,t,s)=>{r=new Kf(r,s),e=new Zf(e,s);let n,i,o,a,c;switch(t){case">":n=Qo,i=th,o=Zo,a=">",c=">=";break;case"<":n=Zo,i=rh,o=Qo,a="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(eh(r,e,s))return!1;for(let l=0;l<e.set.length;++l){let f=e.set[l],u=null,d=null;if(f.forEach(p=>{p.semver===Qf&&(p=new ea(">=0.0.0")),u=u||p,d=d||p,n(p.semver,u.semver,s)?u=p:o(p.semver,d.semver,s)&&(d=p)}),u.operator===a||u.operator===c||(!d.operator||d.operator===a)&&i(r,d.semver))return!1;if(d.operator===c&&o(r,d.semver))return!1}return!0};ta.exports=sh});var sa=E((dm,ra)=>{"use strict";var nh=vr(),ih=(r,e,t)=>nh(r,e,">",t);ra.exports=ih});var ia=E((pm,na)=>{"use strict";var oh=vr(),ah=(r,e,t)=>oh(r,e,"<",t);na.exports=ah});var ca=E((mm,aa)=>{"use strict";var oa=ae(),ch=(r,e,t)=>(r=new oa(r,t),e=new oa(e,t),r.intersects(e,t));aa.exports=ch});var ua=E((gm,la)=>{"use strict";var lh=$t(),uh=oe();la.exports=(r,e,t)=>{let s=[],n=null,i=null,o=r.sort((f,u)=>uh(f,u,t));for(let f of o)lh(f,e,t)?(i=f,n||(n=f)):(i&&s.push([n,i]),i=null,n=null);n&&s.push([n,null]);let a=[];for(let[f,u]of s)f===u?a.push(f):!u&&f===o[0]?a.push("*"):u?f===o[0]?a.push(`<=${u}`):a.push(`${f} - ${u}`):a.push(`>=${f}`);let c=a.join(" || "),l=typeof e.raw=="string"?e.raw:String(e);return c.length<l.length?c:e}});var ga=E((vm,ma)=>{"use strict";var fa=ae(),Ps=kt(),{ANY:Is}=Ps,Ot=$t(),Cs=oe(),fh=(r,e,t={})=>{if(r===e)return!0;r=new fa(r,t),e=new fa(e,t);let s=!1;e:for(let n of r.set){for(let i of e.set){let o=dh(n,i,t);if(s=s||o!==null,o)continue e}if(s)return!1}return!0},hh=[new Ps(">=0.0.0-0")],ha=[new Ps(">=0.0.0")],dh=(r,e,t)=>{if(r===e)return!0;if(r.length===1&&r[0].semver===Is){if(e.length===1&&e[0].semver===Is)return!0;t.includePrerelease?r=hh:r=ha}if(e.length===1&&e[0].semver===Is){if(t.includePrerelease)return!0;e=ha}let s=new Set,n,i;for(let p of r)p.operator===">"||p.operator===">="?n=da(n,p,t):p.operator==="<"||p.operator==="<="?i=pa(i,p,t):s.add(p.semver);if(s.size>1)return null;let o;if(n&&i){if(o=Cs(n.semver,i.semver,t),o>0)return null;if(o===0&&(n.operator!==">="||i.operator!=="<="))return null}for(let p of s){if(n&&!Ot(p,String(n),t)||i&&!Ot(p,String(i),t))return null;for(let b of e)if(!Ot(p,String(b),t))return!1;return!0}let a,c,l,f,u=i&&!t.includePrerelease&&i.semver.prerelease.length?i.semver:!1,d=n&&!t.includePrerelease&&n.semver.prerelease.length?n.semver:!1;u&&u.prerelease.length===1&&i.operator==="<"&&u.prerelease[0]===0&&(u=!1);for(let p of e){if(f=f||p.operator===">"||p.operator===">=",l=l||p.operator==="<"||p.operator==="<=",n){if(d&&p.semver.prerelease&&p.semver.prerelease.length&&p.semver.major===d.major&&p.semver.minor===d.minor&&p.semver.patch===d.patch&&(d=!1),p.operator===">"||p.operator===">="){if(a=da(n,p,t),a===p&&a!==n)return!1}else if(n.operator===">="&&!Ot(n.semver,String(p),t))return!1}if(i){if(u&&p.semver.prerelease&&p.semver.prerelease.length&&p.semver.major===u.major&&p.semver.minor===u.minor&&p.semver.patch===u.patch&&(u=!1),p.operator==="<"||p.operator==="<="){if(c=pa(i,p,t),c===p&&c!==i)return!1}else if(i.operator==="<="&&!Ot(i.semver,String(p),t))return!1}if(!p.operator&&(i||n)&&o!==0)return!1}return!(n&&l&&!i&&o!==0||i&&f&&!n&&o!==0||d||u)},da=(r,e,t)=>{if(!r)return e;let s=Cs(r.semver,e.semver,t);return s>0?r:s<0||e.operator===">"&&r.operator===">="?e:r},pa=(r,e,t)=>{if(!r)return e;let s=Cs(r.semver,e.semver,t);return s<0?r:s>0||e.operator==="<"&&r.operator==="<="?e:r};ma.exports=fh});var ks=E((ym,Ea)=>{"use strict";var Rs=tt(),va=_t(),ph=X(),ya=fs(),mh=qe(),gh=Fi(),vh=Vi(),yh=ji(),Eh=Bi(),Th=zi(),wh=Hi(),Sh=Yi(),bh=Qi(),xh=oe(),_h=ro(),Ih=no(),Ph=ur(),Ch=co(),Rh=uo(),kh=Pt(),Nh=fr(),$h=ds(),Oh=ps(),Lh=hr(),Ah=dr(),Fh=ms(),Dh=To(),Vh=kt(),qh=ae(),Wh=$t(),jh=Uo(),Uh=Bo(),Mh=zo(),Bh=Jo(),Gh=Ko(),zh=vr(),Xh=sa(),Hh=ia(),Jh=ca(),Yh=ua(),Kh=ga();Ea.exports={parse:mh,valid:gh,clean:vh,inc:yh,diff:Eh,major:Th,minor:wh,patch:Sh,prerelease:bh,compare:xh,rcompare:_h,compareLoose:Ih,compareBuild:Ph,sort:Ch,rsort:Rh,gt:kh,lt:Nh,eq:$h,neq:Oh,gte:Lh,lte:Ah,cmp:Fh,coerce:Dh,Comparator:Vh,Range:qh,satisfies:Wh,toComparators:jh,maxSatisfying:Uh,minSatisfying:Mh,minVersion:Bh,validRange:Gh,outside:zh,gtr:Xh,ltr:Hh,intersects:Jh,simplifyRange:Yh,subset:Kh,SemVer:ph,re:Rs.re,src:Rs.src,tokens:Rs.t,SEMVER_SPEC_VERSION:va.SEMVER_SPEC_VERSION,RELEASE_TYPES:va.RELEASE_TYPES,compareIdentifiers:ya.compareIdentifiers,rcompareIdentifiers:ya.rcompareIdentifiers}});var za=E(lt=>{"use strict";Object.defineProperty(lt,"__esModule",{value:!0});lt.IstanbulCoverageContext=lt.IstanbulMissingCoverageError=void 0;var Ma=require("fs"),md=require("path"),ge=require("vscode"),Ga="coverage-final.json",br=class extends Error{constructor(e,t){super(`Could not read ${Ga} in ${e}. Make sure the test was run with "json" coverage enabled: ${t}`)}};lt.IstanbulMissingCoverageError=br;var Us=class{constructor(e){this.defaultOptions={removeCoverageDataAtEndOfRun:!0,booleanCounts:!1},this.loadDetailedCoverage=async(t,s)=>{if(!(s instanceof xr))return[];let n=s.options,i=[],o=[];for(let[a,c]of Object.entries(s.original.branchMap))o.push(Promise.all([Dt(n,s.compiledUri,c.loc),...c.locations.map(l=>l.start.line!==void 0?Dt(n,s.compiledUri,l):Dt(n,s.compiledUri,{start:c.loc.end,end:c.loc.end}))]).then(([l,...f])=>{if(!(!l||f.some(u=>!u))){let u=0,d=[];for(let[p,b]of f.entries()){let v=s.original.b[a][p];u+=v,d.push(new ge.BranchCoverage(Sr(n,v),b,c.type==="if"?p===0?"if":"else":void 0))}i.push(new ge.StatementCoverage(Sr(n,u),l,d))}}));for(let[a,c]of Object.entries(s.original.statementMap))o.push(Dt(n,s.compiledUri,c).then(l=>{l&&i.push(new ge.StatementCoverage(Sr(n,s.original.s[a]),l))}));for(let[a,c]of Object.entries(s.original.fnMap))o.push(Dt(n,s.compiledUri,c.loc).then(l=>{l&&i.push(new ge.DeclarationCoverage(c.name,Sr(n,s.original.f[a]),l))}));return await Promise.all(o),i},Object.assign(this.defaultOptions,e)}async apply(e,t,s){let n;try{n=JSON.parse(await Ma.promises.readFile((0,md.join)(t,Ga),"utf-8"))}catch(o){throw new br(t,o)}let i={...this.defaultOptions,...s};if(i.removeCoverageDataAtEndOfRun){let o=e.onDidDispose(()=>{o.dispose(),Ma.promises.rm(t,{recursive:!0}).catch(()=>{})})}return this.applyJson(e,n,i)}async applyJson(e,t,s){let n={...this.defaultOptions,...s};await Promise.all(Object.values(t).map(async i=>{let o=ge.Uri.file(i.path),a=n.mapFileUri?await n.mapFileUri?.(o):o;a&&e.addCoverage(new xr(a,i,o,n))}))}};lt.IstanbulCoverageContext=Us;var Dt=async(r,e,t)=>{let[s,n]=await Promise.all([Ba(r,e,t.start),Ba(r,e,t.end)]);if(s&&n)return new ge.Range(s.range.start,n.range.end);let i=s||n;if(i)return i.range},Ba=async(r,e,t)=>{let s=new ge.Position(t.line-1,t.column);return r.mapLocation?.(e,s)||new ge.Location(e,s)},Sr=(r,e)=>r.booleanCounts?e>0:e,xr=class extends ge.FileCoverage{constructor(e,t,s,n){super(e,js(t.s),js(t.b),js(t.f)),this.original=t,this.compiledUri=s,this.options=n}},js=r=>{let e=0,t=0;for(let s of Object.values(r))if(s instanceof Array)for(let n of s)e+=n?1:0,t++;else e+=s?1:0,t++;return new ge.TestCoverageCount(e,t)}});var qd={};yc(qd,{activate:()=>Dd,deactivate:()=>Vd});module.exports=Ec(qd);var C=O(require("vscode"));Promise.withResolvers||(Promise.withResolvers=function(){let e,t,s=new this((n,i)=>{e=n,t=i});return{resolve:e,reject:t,promise:s}});var Tc=/^[A-Za-z]:\//;function qt(r=""){return r&&r.replace(/\\/g,"/").replace(Tc,e=>e.toUpperCase())}var wc=/^[/\\]{2}/,Sc=/^[/\\](?![/\\])|^[/\\]{2}(?!\.)|^[A-Za-z]:[/\\]/,nn=/^[A-Za-z]:$/,sn=/^\/([A-Za-z]:)?$/;var L=function(r){if(r.length===0)return".";r=qt(r);let e=r.match(wc),t=Xe(r),s=r[r.length-1]==="/";return r=Dr(r,!t),r.length===0?t?"/":s?"./":".":(s&&(r+="/"),nn.test(r)&&(r+="/"),e?t?`//${r}`:`//./${r}`:t&&!Xe(r)?`/${r}`:r)},Fr=function(...r){if(r.length===0)return".";let e;for(let t of r)t&&t.length>0&&(e===void 0?e=t:e+=`/${t}`);return e===void 0?".":L(e.replace(/\/\/+/g,"/"))};function bc(){return typeof process<"u"&&typeof process.cwd=="function"?process.cwd().replace(/\\/g,"/"):"/"}var pe=function(...r){r=r.map(s=>qt(s));let e="",t=!1;for(let s=r.length-1;s>=-1&&!t;s--){let n=s>=0?r[s]:bc();!n||n.length===0||(e=`${n}/${e}`,t=Xe(n))}return e=Dr(e,!t),t&&!Xe(e)?`/${e}`:e.length>0?e:"."};function Dr(r,e){let t="",s=0,n=-1,i=0,o=null;for(let a=0;a<=r.length;++a){if(a<r.length)o=r[a];else{if(o==="/")break;o="/"}if(o==="/"){if(!(n===a-1||i===1))if(i===2){if(t.length<2||s!==2||t[t.length-1]!=="."||t[t.length-2]!=="."){if(t.length>2){let c=t.lastIndexOf("/");c===-1?(t="",s=0):(t=t.slice(0,c),s=t.length-1-t.lastIndexOf("/")),n=a,i=0;continue}else if(t.length>0){t="",s=0,n=a,i=0;continue}}e&&(t+=t.length>0?"/..":"..",s=2)}else t.length>0?t+=`/${r.slice(n+1,a)}`:t=r.slice(n+1,a),s=a-n-1;n=a,i=0}else o==="."&&i!==-1?++i:i=-1}return t}var Xe=function(r){return Sc.test(r)};var ee=function(r,e){let t=pe(r).replace(sn,"$1").split("/"),s=pe(e).replace(sn,"$1").split("/");if(s[0][1]===":"&&t[0][1]===":"&&t[0]!==s[0])return s.join("/");let n=[...t];for(let i of n){if(s[0]!==i)break;t.shift(),s.shift()}return[...t.map(()=>".."),...s].join("/")},M=function(r){let e=qt(r).replace(/\/$/,"").split("/").slice(0,-1);return e.length===1&&nn.test(e[0])&&(e[0]+="/"),e.join("/")||(Xe(r)?"/":".")};var z=function(r,e){let t=qt(r).split("/").pop();return e&&t.endsWith(e)?t.slice(0,-e.length):t};var on="1.16.0";var an=require("os"),ye=require("path"),Pe=O(require("vscode"));var cn="vitest";function _c(r,e,t,s){return typeof s=="boolean"?e.get(t)??r.get(t)??s:e.get(t)||r.get(t)||s}function N(r){!r&&Pe.workspace.workspaceFolders?.length===1&&(r=Pe.workspace.workspaceFolders[0]);let e=Pe.workspace.getConfiguration("vitest",r),t=Pe.workspace.getConfiguration("vitest"),s=(y,R)=>_c(t,e,y,R),n=s("nodeExecutable"),i=s("workspaceConfig"),o=s("rootConfig"),a=s("configSearchPatternExclude","{**/node_modules/**,**/.*/**,**/*.d.ts}"),c=s("vitestPackagePath"),l=r&&c?(0,ye.resolve)(r.uri.fsPath,c.replace("${workspaceFolder}",r.uri.fsPath)):c,f=s("logLevel","info"),u=s("filesWatcherInclude","**/*"),d=s("terminalShellArgs"),p=s("terminalShellPath"),b=s("shellType","child_process"),v=s("nodeExecArgs"),w=s("experimentalStaticAstCollect",!1),I=s("cliArguments"),P=s("debugOutFiles",[]);return{env:s("nodeEnv",null),debugExclude:s("debugExclude"),debugOutFiles:P,filesWatcherInclude:u,terminalShellArgs:d,terminalShellPath:p,shellType:b,cliArguments:I,nodeExecArgs:v,experimentalStaticAstCollect:w,vitestPackagePath:l,workspaceConfig:Vr(i),rootConfig:Vr(o),configSearchPatternExclude:a,maximumConfigs:s("maximumConfigs",3),nodeExecutable:Vr(n),disableWorkspaceWarning:s("disableWorkspaceWarning",!1),debuggerPort:s("debuggerPort")||void 0,debuggerAddress:s("debuggerAddress",void 0)||void 0,logLevel:f}}function Vr(r){if(!r||(0,ye.isAbsolute)(r))return r;if(r.startsWith("~/"))return(0,ye.resolve)((0,an.homedir)(),r.slice(2));if(Pe.workspace.workspaceFile)return(0,ye.resolve)((0,ye.dirname)(Pe.workspace.workspaceFile.fsPath),r);let e=Pe.workspace.workspaceFolders;return e?.length===1?(0,ye.resolve)(e[0].uri.fsPath,r):r}var Ne=require("path");var at=O(require("vscode"));var jt=require("fs"),un=require("vscode");var He=process.env.VITEST_VSCODE_E2E_LOG_FILE,pt=un.window.createOutputChannel("Vitest"),qr=new Set;function Ic(r){for(let e of qr)e(r)}var h={onWorkerLog(r){qr.add(r)},offWorkerLog(r){qr.delete(r)},worker:(r,...e)=>{typeof e.at(-1)=="string"&&e.at(-1).endsWith(`
`)&&(e[e.length-1]=e.at(-1).slice(0,process.platform==="win32"?-2:-1));let s=`[INFO ${new Date().toLocaleTimeString()}] [Worker] ${e.join(" ")}`;He&&Wt(s),Ic(s),pt.appendLine(s)},info:(...r)=>{let t=`[INFO ${new Date().toLocaleTimeString()}] ${r.join(" ")}`;He&&Wt(t),pt.appendLine(t)},error:(...r)=>{let e=new Date().toLocaleTimeString();for(let s=0;s<r.length;s++)if(r[s]instanceof Error){let n=r[s];r[s]=`[Error ${n.name}] ${n.message}
${n.stack}`}let t=`[Error ${e}] ${r.join(" ")}`;He&&Wt(t),pt.appendLine(t)},verbose:N().logLevel==="verbose"||process.env.VITEST_VSCODE_LOG==="verbose"?(...r)=>{let t=`[${new Date().toLocaleTimeString()}] ${r.join(" ")}`;He&&Wt(t),pt.appendLine(t)}:void 0,workspaceInfo:(r,...e)=>{h.info(`[Workspace ${r}]`,...e)},workspaceError:(r,...e)=>{h.error(`[Workspace ${r}]`,...e)},openOuput(){pt.show()}},ln=!1;function Wt(r){ln||((0,jt.writeFileSync)(He,""),ln=!0),(0,jt.appendFileSync)(He,`${r}
`)}function Ut(r){return(...e)=>{h.error(r,...e)}}var Pc=O(require("fs")),le=O(require("vscode"));function fn(){}function mt(r){return`Vitest v${r.version} (${ee(M(r.cwd),r.id)})`}async function hn(r){let e=new Set(r.map(i=>i.folder)),t=new TextEncoder,s=[...e].map(async i=>{let o=r.filter(f=>f.folder===i).map(f=>ee(i.uri.fsPath,f.configFile)),a=o.every(f=>/\.m?ts$/.test(f))?"ts":"js",c=le.Uri.joinPath(i.uri,`vitest.workspace.${a}`),l=`
import { defineWorkspace } from 'vitest/config'

export default defineWorkspace([
  ${o.map(f=>`"./${f}"`).join(`,
  `)}
])
`.trimStart();return await le.workspace.fs.writeFile(c,t.encode(l)),await le.workspace.openTextDocument(c)}),n=await Promise.all(s);n[0]&&await le.window.showTextDocument(n[0]),await le.window.showInformationMessage("Created vitest.workspace.js. You might need to run `npm i --save-dev vitest` in the root folder to install Vitest.")}function Cc(r,e){e&&h.error(e),le.window.showErrorMessage(`${r}. Check the output for more details.`,"See error").then(t=>{t==="See error"&&le.commands.executeCommand("vitest.openOutput")})}var te=Wr(Cc,100);function Wr(r,e=20){let t;return(...n)=>{t&&clearTimeout(t),t=setTimeout(()=>r(...n),e)}}var _a=require("http"),At=O(require("vscode"));var mn=O(require("net"),1),gn=O(require("os"),1),Bt=class extends Error{constructor(e){super(`${e} is locked`)}},Je={old:new Set,young:new Set},Rc=1e3*15;var Mt,kc=()=>{let r=gn.default.networkInterfaces(),e=new Set([void 0,"0.0.0.0"]);for(let t of Object.values(r))for(let s of t)e.add(s.address);return e},dn=r=>new Promise((e,t)=>{let s=mn.default.createServer();s.unref(),s.on("error",t),s.listen(r,()=>{let{port:n}=s.address();s.close(()=>{e(n)})})}),pn=async(r,e)=>{if(r.host||r.port===0)return dn(r);for(let t of e)try{await dn({port:r.port,host:t})}catch(s){if(!["EADDRNOTAVAIL","EINVAL"].includes(s.code))throw s}return r.port},Nc=function*(r){r&&(yield*r),yield 0};async function $e(r){let e,t=new Set;if(r&&(r.port&&(e=typeof r.port=="number"?[r.port]:r.port),r.exclude)){let n=r.exclude;if(typeof n[Symbol.iterator]!="function")throw new TypeError("The `exclude` option must be an iterable.");for(let i of n){if(typeof i!="number")throw new TypeError("Each item in the `exclude` option must be a number corresponding to the port you want excluded.");if(!Number.isSafeInteger(i))throw new TypeError(`Number ${i} in the exclude option is not a safe integer and can't be used`)}t=new Set(n)}Mt===void 0&&(Mt=setInterval(()=>{Je.old=Je.young,Je.young=new Set},Rc),Mt.unref&&Mt.unref());let s=kc();for(let n of Nc(e))try{if(t.has(n))continue;let i=await pn({...r,port:n},s);for(;Je.old.has(i)||Je.young.has(i);){if(n!==0)throw new Bt(n);i=await pn({...r,port:n},s)}return Je.young.add(i),i}catch(i){if(!["EADDRINUSE","EACCES"].includes(i.code)&&!(i instanceof Bt))throw i}throw new Error("No available ports found")}var Yl=O(Tn(),1),Kl=O(Kr(),1),Ql=O(es(),1),Zl=O(as(),1),Ve=O(Ti(),1);var nr="1.4.0";var xp=__dirname,ke=pe(__dirname,"worker.js"),_p=pe(__dirname,"setupFile.mjs"),ir="**/*{vite,vitest}*.config*.{ts,js,mjs,cjs,cts,mts}",or="**/*vitest.{workspace,projects}*.{ts,js,mjs,cjs,cts,mts,json}",wi="coverage-final.json";var ba=require("url"),xa=O(ks());var Ns=O(require("v8"));function Ta(r){return r}var Qh=Ta,{clearTimeout:Zh,setTimeout:ed}=globalThis,td=Math.random.bind(Math);function wa(r,e){let{post:t,on:s,off:n=()=>{},eventNames:i=[],serialize:o=Ta,deserialize:a=Qh,resolver:c,bind:l="rpc",timeout:f=6e4}=e,u=new Map,d,p=!1,b=new Proxy({},{get(I,P){if(P==="$functions")return r;if(P==="$close")return v;if(P==="then"&&!i.includes("then")&&!("then"in r))return;let y=(...k)=>{t(o({m:P,a:k,t:"q"}))};if(i.includes(P))return y.asEvent=y,y;let R=async(...k)=>{if(p)throw new Error(`[birpc] rpc is closed, cannot call "${P}"`);if(d)try{await d}finally{d=void 0}return new Promise((U,q)=>{let S=sd(),x;f>=0&&(x=ed(()=>{try{throw e.onTimeoutError?.(P,k),new Error(`[birpc] timeout on calling "${P}"`)}catch(ze){q(ze)}u.delete(S)},f),typeof x=="object"&&(x=x.unref?.())),u.set(S,{resolve:U,reject:q,timeoutId:x,method:P}),t(o({m:P,a:k,i:S,t:"q"}))})};return R.asEvent=y,R}});function v(){p=!0,u.forEach(({reject:I,method:P})=>{I(new Error(`[birpc] rpc is closed, cannot call "${P}"`))}),u.clear(),n(w)}async function w(I,...P){let y=a(I);if(y.t==="q"){let{m:R,a:k}=y,U,q,S=c?c(R,r[R]):r[R];if(!S)q=new Error(`[birpc] function "${R}" not found`);else try{U=await S.apply(l==="rpc"?b:r,k)}catch(x){q=x}y.i&&(q&&e.onError&&e.onError(q,R,k),t(o({t:"s",i:y.i,r:U,e:q}),...P))}else{let{i:R,r:k,e:U}=y,q=u.get(R);q&&(Zh(q.timeoutId),U?q.reject(U):q.resolve(k)),u.delete(R)}}return d=s(w),b}var rd="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";function sd(r=21){let e="",t=r;for(;t--;)e+=rd[td()*64|0];return e}function it(){let r=[];return{handlers:r,register:e=>r.push(e),trigger:(...e)=>r.forEach(t=>t(...e)),clear:()=>r.length=0,remove:e=>{let t=r.indexOf(e);t!==-1&&r.splice(t,1)}}}function nd(){let r={onConsoleLog:it(),onTaskUpdate:it(),onFinished:it(),onCollected:it(),onWatcherRerun:it(),onWatcherStart:it()};return{events:{onConsoleLog:r.onConsoleLog.trigger,onFinished:r.onFinished.trigger,onTaskUpdate:r.onTaskUpdate.trigger,onCollected:r.onCollected.trigger,onWatcherRerun:r.onWatcherRerun.trigger,onWatcherStart:r.onWatcherStart.trigger},handlers:{onConsoleLog:r.onConsoleLog.register,onTaskUpdate:r.onTaskUpdate.register,onFinished:r.onFinished.register,onCollected:r.onCollected.register,onWatcherRerun:r.onWatcherRerun.register,onWatcherStart:r.onWatcherStart.register,removeListener(t,s){r[t]?.remove(s)},clearListeners(){for(let t in r)r[t]?.clear()}}}}function Sa(r){let{events:e,handlers:t}=nd();return{api:wa(e,{timeout:-1,bind:"functions",on(n){r.on(n)},post(n){r.send(n)},serialize:Ns.default.serialize,deserialize:n=>Ns.default.deserialize(Buffer.from(n))}),handlers:t}}function ot(r,e,t,s){return new Promise((n,i)=>{r.once("connection",c=>{function l(v){let w=JSON.parse(v.toString());if(w.type==="debug"&&h.worker("info",...w.args),w.type==="ready"){let{api:I,handlers:P}=Sa({on:y=>c.on("message",y),send:y=>c.send(y)});c.once("close",()=>{h.verbose?.("[API]","Vitest WebSocket connection closed, cannot call RPC anymore."),I.$close()}),n({rpc:I,workspaceSource:w.workspaceSource,handlers:{...P,onStdout(){}},configs:w.configs,ws:c,pkg:e})}if(w.type==="error"){let I=new Error(`Vitest failed to start: 
${w.error}`);i(I)}c.off("error",f),c.off("message",l),c.off("close",u)}function f(v){h.error("[API]",v),i(v),c.off("error",f),c.off("message",l),c.off("close",u)}function u(v){i(new Error(`Vitest process exited with code ${v}`))}r.off("error",a),r.off("exit",o),c.on("error",f),c.on("message",l),c.on("close",u);let d=e.loader,p=e.pnp,b={type:"init",meta:{shellType:s,vitestNodePath:e.vitestNodePath,env:N(e.folder).env||void 0,configFile:e.configFile,cwd:e.cwd,arguments:e.arguments,workspaceFile:e.workspaceFile,id:e.id,pnpApi:p,pnpLoader:d&&(0,xa.gte)(process.version,"18.19.0")?(0,ba.pathToFileURL)(d).toString():void 0},debug:t,astCollect:N(e.folder).experimentalStaticAstCollect};c.send(JSON.stringify(b))});function o(){i(new Error("Cannot establish connection with Vitest process."))}function a(c){i(c)}r.on("error",a),r.once("close",o)})}async function Ia(r){let e=await $e(),t=(0,_a.createServer)().listen(e).unref(),s=new Ve.default({server:t}),n=`ws://localhost:${e}`,i=N(r.folder),o=i.env||{},a=At.window.createTerminal({hideFromUser:!0,cwd:r.folder.uri,isTransient:!1,shellArgs:i.terminalShellArgs,shellPath:i.terminalShellPath,env:{...o,VITEST_WS_ADDRESS:n,VITEST_VSCODE:"true",TEST:"true",VITEST:"true",NODE_ENV:o.NODE_ENV??process.env.NODE_ENV??"test"}}),c=`node ${ke}`;h.info("[API]",`Initiated ws connection via ${n}`),h.info("[API]",`Starting ${mt(r)} in the terminal: ${c}`),a.sendText(c,!0);let l=await ot(s,r,!1,"terminal"),f=await a.processId??Math.random();h.info("[API]",`${mt(r)} terminal process ${f} created`);let u=new Lt(f,a,t,l.ws);return{rpc:l.rpc,handlers:l.handlers,pkg:r,workspaceSource:l.workspaceSource,process:u,configs:l.configs}}var Lt=class{constructor(e,t,s,n){this.id=e;this.terminal=t;this.stopped=new Promise(i=>{let o=At.window.onDidCloseTerminal(async a=>{if(a===t){let c=a.exitStatus?.code;this._onDidExit.fire(c??null),this._onDidExit.dispose(),s.close(Ut("Failed to close server")),o.dispose(),i()}})}),n.on("close",()=>{this.close()})}_onDidExit=new At.EventEmitter;stopped;show(){this.terminal.show(!1)}get closed(){return this.terminal.exitStatus!==void 0}close(){return this.terminal.sendText(""),setTimeout(()=>this.terminal.dispose(),1),new Promise((e,t)=>{let s=setTimeout(()=>{t(new Error("The extension terminal process did not exit in time."))},5e3);this.stopped.finally(()=>clearTimeout(s)).then(e,t)})}onError(){return()=>{}}onExit(e){let t=this._onDidExit.event(e);return()=>{t.dispose()}}};var Pa=require("child_process"),Ca=require("url"),Ra=require("http");async function ka(r){let e=r.loader,t=r.pnp;if(e&&!t)throw new Error("pnp file is required if loader option is used");let s=N().env||{},n=N(r.folder).nodeExecArgs||[],i=e&&t?["--require",t,"--experimental-loader",(0,Ca.pathToFileURL)(e).toString(),...n]:n,o=i.join(" "),a=`node ${o?`${o} `:""}${ke}`.trim();h.info("[API]",`Running ${mt(r)} with "${a}"`);let c=N(r.folder).logLevel,l=await $e(),f=(0,Ra.createServer)().listen(l).unref(),u=new Ve.default({server:f}),d=`ws://localhost:${l}`,p=(0,Pa.spawn)(N(r.folder).nodeExecutable||"node",[...i,ke],{env:{...process.env,...s,VITEST_VSCODE_LOG:s.VITEST_VSCODE_LOG??process.env.VITEST_VSCODE_LOG??c,VITEST_VSCODE:"true",TEST:"true",VITEST_WS_ADDRESS:d,VITEST:"true",NODE_ENV:s.NODE_ENV??process.env.NODE_ENV??"test"},cwd:r.cwd}),b=new Set;return p.stdout?.on("data",v=>{let w=v.toString();b.forEach(I=>I(w)),h.worker("info",w)}),p.stderr?.on("data",v=>{let w=v.toString();if(h.worker("error",w),b.forEach(I=>I(w)),w.startsWith(" MISSING DEPENDENCY")){let I=w.split(/\r?\n/,1)[0].slice(19);te(I)}}),p.on("exit",()=>{b.clear()}),new Promise((v,w)=>{function I(y){w(new Error(`Vitest process exited with code ${y}`))}function P(y){w(y)}p.on("exit",I),p.on("error",P),ot(u,r,!1,"child_process").then(y=>{y.handlers.onStdout=k=>{b.add(k)};let R=y.handlers.clearListeners;y.handlers.clearListeners=()=>{R(),b.clear()},v({...y,process:new $s(p,f,y.ws)})},w).finally(()=>{p.off("exit",I),p.off("exit",P)})})}var $s=class{constructor(e,t,s){this.child=e;this.id=e.pid,this.stopped=new Promise((n,i)=>{e.on("exit",()=>{t.close(Ut("Failed to close server")),n()}),e.on("error",i)}),s.on("close",()=>{e.killed||e.kill()})}id;stopped;get closed(){return this.child.killed}close(){return this.child.kill(),new Promise((e,t)=>{let s=setTimeout(()=>{t(new Error("The extension child process did not exit in time."))},5e3);this.stopped.finally(()=>clearTimeout(s)).then(e,t)})}onError(e,t){let s=t?.once?"once":"on";return this.child[s]("error",e),()=>{this.child.off("error",e)}}onExit(e,t){let s=t?.once?"once":"on";return this.child[s]("exit",e),()=>{this.child.off("exit",e)}}};var As=class{constructor(e){this.api=e;this.processes.forEach(t=>{let s=i=>{this.disposing||te("Vitest process failed",i)},n=t.onError(s);this._disposes.push(n)})}disposing=!1;_disposes=[];onUnexpectedExit(e){this.processes.forEach(t=>{let s=i=>{this.disposing||e(i)},n=t.onExit(s);this._disposes.push(n)})}forEach(e){return this.api.forEach(e)}get folderAPIs(){return this.api}async dispose(){this.disposing=!0;try{this._disposes.forEach(e=>e()),await Promise.all(this.api.map(e=>e.dispose()))}finally{this.disposing=!1}}get processes(){return this.api.map(e=>e.process)}},Ft=class{constructor(e,t){this.pkg=e;this.meta=t;let s=L(e.id);this.id=s,this.workspaceFolder=e.folder,this.handlers=t.handlers,this.tag=new at.TestTag(e.prefix)}id;tag;workspaceFolder;handlers;createDate=Date.now();get processId(){return this.process.id}get prefix(){return this.pkg.prefix}get process(){return this.meta.process}get configs(){return this.meta.configs}get workspaceSource(){return this.meta.workspaceSource}get version(){return this.pkg.version}get package(){return this.pkg}async runFiles(e,t){await this.meta.rpc.runTests(Ls(e),t)}async updateSnapshots(e,t){await this.meta.rpc.updateSnapshots(Ls(e),t)}getFiles(){return this.meta.rpc.getFiles()}onFileCreated=Os(async e=>{if(!this.process.closed)return this.meta.rpc.onFilesCreated(e).catch(t=>{h.error("[API]","Failed to notify Vitest about file creation",t)})});onFileChanged=Os(async e=>{if(!this.process.closed)return this.meta.rpc.onFilesChanged(e).catch(t=>{h.error("[API]","Failed to notify Vitest about file change",t)})});async collectTests(e,t){return this._collectTests(`${e}\0${L(t)}`)}_collectTests=Os(async e=>{if(this.process.closed)return;let t=Array.from(e).map(n=>{let[i,o]=n.split("\0",2);return[i,o]}),s=this.workspaceFolder.uri.fsPath;return h.info("[API]",`Collecting tests: ${t.map(n=>`${ee(s,n[1])}${n[0]?` [${n[0]}]`:""}`).join(", ")}`),this.meta.rpc.collectTests(t)});async dispose(){if(this.handlers.clearListeners(),delete require.cache[this.meta.pkg.vitestPackageJsonPath],delete require.cache[this.meta.pkg.vitestNodePath],!this.meta.process.closed){try{await this.meta.rpc.close(),h.info("[API]",`Vitest process ${this.processId} closed successfully`)}catch(e){h.error("[API]","Failed to close Vitest RPC",e)}await this.meta.process.close().catch(e=>{h.error("[API]","Failed to close Vitest process",e)})}}async cancelRun(){this.process.closed||await this.meta.rpc.cancelRun()}waitForCoverageReport(){return this.meta.rpc.waitForCoverageReport()}async invalidateIstanbulTestModules(e){await this.meta.rpc.invalidateIstanbulTestModules(e)}async enableCoverage(){await this.meta.rpc.enableCoverage()}async disableCoverage(){await this.meta.rpc.disableCoverage()}async watchTests(e,t){await this.meta.rpc.watchTests(Ls(e),t)}async unwatchTests(){await this.meta.rpc.unwatchTests()}onConsoleLog=this.createHandler("onConsoleLog");onTaskUpdate=this.createHandler("onTaskUpdate");onFinished=this.createHandler("onFinished");onCollected=this.createHandler("onCollected");onWatcherStart=this.createHandler("onWatcherStart");onWatcherRerun=this.createHandler("onWatcherRerun");clearListeners(e){e&&this.handlers.removeListener(e,this.handlers[e]),this.handlers.clearListeners()}onStdout(e){this.handlers.onStdout(e)}createHandler(e){return t=>{this.handlers[e](t)}}};function Os(r){let e=new Set,t=null,s=null;return n=>{e.add(n),s&&clearTimeout(s),s=setTimeout(()=>{if(t)return;let i=Array.from(e);e.clear(),t=r(i).finally(()=>{t=null})},50)}}async function $a(r,e){let t=new Set,s=r.map(l=>Na(t,l));s.length&&h.info("[API]",`Resolving workspace configs: ${r.map(l=>ee(l.folder.uri.fsPath,l.id)).join(", ")}`);let n=await Promise.all(s),i=e.filter(l=>!l.configFile||l.workspaceFile||!t.has(l.configFile)).sort((l,f)=>{let u=l.id.split("/").length,d=f.id.split("/").length;return u-d}),o=N().maximumConfigs??3,a=n.map(l=>l.workspaceSource?(0,Ne.dirname)(l.workspaceSource):null).filter(l=>l!=null),c=0;i.length&&h.info("[API]",`Resolving configs: ${i.map(l=>ee((0,Ne.dirname)(l.cwd),l.id)).join(", ")}`);for(let l of i){if(l.configFile&&t.has(l.configFile)){h.info("[API]",`Ignoring config ${ee((0,Ne.dirname)(l.cwd),l.id)} because it's already used by the workspace`);continue}if(l.configFile&&id(a,l.configFile)){h.info("[API]",`Ignoring config ${ee((0,Ne.dirname)(l.cwd),l.id)} because there is a workspace config in the parent folder`);continue}if(c++,c>o){od(i);break}let f=await Na(t,l);n.push(f),f.workspaceSource&&a.push((0,Ne.dirname)(f.workspaceSource))}return new As(n)}function id(r,e){return r.some(t=>{let s=ee(t,e);return!s.startsWith("..")&&!(0,Ne.isAbsolute)(s)})}function od(r){let e=N().maximumConfigs??3,t=["Vitest found multiple config files.",`The extension will use only the first ${e} due to performance concerns.`,"Consider using a workspace configuration to group your configs or increase",'the limit via "vitest.maximumConfigs" option.'].join(" "),s=Array.from(new Set(r.map(o=>o.folder))),n=[...r],i=r.splice(e);s.every(o=>N(o).disableWorkspaceWarning!==!0)?at.window.showWarningMessage(t,"Create vitest.workspace.js","Disable notification").then(o=>{o==="Create vitest.workspace.js"&&hn(n).catch(fn),o==="Disable notification"&&s.forEach(a=>{at.workspace.getConfiguration("vitest",a).update("disableWorkspaceWarning",!0)})}):(h.info(t),h.info(`Discarded config files: ${i.map(o=>o.workspaceFile||o.configFile).join(", ")}`))}async function Na(r,e){let t=N(e.folder);t.cliArguments&&!e.arguments&&(e.arguments=`vitest ${t.cliArguments}`);let s=t.shellType==="terminal"?await Ia(e):await ka(e);return s.configs.forEach(n=>{r.add(n)}),new Ft(e,s)}function Ls(r){return r&&r.map(e=>typeof e=="string"?L(e):[e[0],L(e[1])])}var Ya=O(require("path")),Ka=require("fs/promises"),zs=require("util"),V=O(require("vscode"));var ad={reset:[0,0],bold:[1,22,"\x1B[22m\x1B[1m"],dim:[2,22,"\x1B[22m\x1B[2m"],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]},cd=Object.entries(ad);function Fs(r){return String(r)}Fs.open="";Fs.close="";function Oa(r=!1){let e=typeof process<"u"?process:void 0,t=e?.env||{},s=e?.argv||[];return!("NO_COLOR"in t||s.includes("--no-color"))&&("FORCE_COLOR"in t||s.includes("--color")||e?.platform==="win32"||r&&t.TERM!=="dumb"||"CI"in t)||typeof window<"u"&&!!window.chrome}function La(r=!1){let e=Oa(r),t=(o,a,c,l)=>{let f="",u=0;do f+=o.substring(u,l)+c,u=l+a.length,l=o.indexOf(a,u);while(~l);return f+o.substring(u)},s=(o,a,c=o)=>{let l=f=>{let u=String(f),d=u.indexOf(a,o.length);return~d?o+t(u,a,c,d)+a:o+u+a};return l.open=o,l.close=a,l},n={isColorSupported:e},i=o=>`\x1B[${o}m`;for(let[o,a]of cd)n[o]=e?s(i(a[0]),i(a[1]),a[2]):Fs;return n}var Aa=require("tty"),ld=La((0,Aa.isatty)(1));var fg=Number.isNaN||(r=>r!==r);var Tg=new RegExp("['\\u0000-\\u001f\\u007f-\\u009f\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]","g");var ud=()=>"Promise{\u2026}";try{let{getPromiseDetails:r,kPending:e,kRejected:t}=process.binding("util");Array.isArray(r(Promise.resolve()))&&(ud=(s,n)=>{let[i,o]=r(s);return i===e?"Promise{<pending>}":`Promise${i===t?"!":""}{${n.inspect(o,n)}}`})}catch{}var hd=typeof Symbol=="function"&&typeof Symbol.for=="function",gv=hd?Symbol.for("chai/inspect"):"@@chai/inspect",Da=!1;try{let r=require("util");Da=r.inspect?r.inspect.custom:!1}catch{Da=!1}function Vs(r){return r==null&&(r=[]),Array.isArray(r)?r:[r]}var Dv=Symbol("vitest:SAFE_TIMERS");var qs,Va;function dd(){if(Va)return qs;Va=1;var r,e,t,s,n,i,o,a,c,l,f,u,d,p,b,v,w,I,P;return d=/\/(?![*\/])(?:\[(?:(?![\]\\]).|\\.)*\]|(?![\/\\]).|\\.)*(\/[$_\u200C\u200D\p{ID_Continue}]*|\\)?/yu,u=/--|\+\+|=>|\.{3}|\??\.(?!\d)|(?:&&|\|\||\?\?|[+\-%&|^]|\*{1,2}|<{1,2}|>{1,3}|!=?|={1,2}|\/(?![\/*]))=?|[?~,:;[\](){}]/y,r=/(\x23?)(?=[$_\p{ID_Start}\\])(?:[$_\u200C\u200D\p{ID_Continue}]|\\u[\da-fA-F]{4}|\\u\{[\da-fA-F]+\})+/yu,b=/(['"])(?:(?!\1)[^\\\n\r]|\\(?:\r\n|[^]))*(\1)?/y,f=/(?:0[xX][\da-fA-F](?:_?[\da-fA-F])*|0[oO][0-7](?:_?[0-7])*|0[bB][01](?:_?[01])*)n?|0n|[1-9](?:_?\d)*n|(?:(?:0(?!\d)|0\d*[89]\d*|[1-9](?:_?\d)*)(?:\.(?:\d(?:_?\d)*)?)?|\.\d(?:_?\d)*)(?:[eE][+-]?\d(?:_?\d)*)?|0[0-7]+/y,v=/[`}](?:[^`\\$]|\\[^]|\$(?!\{))*(`|\$\{)?/y,P=/[\t\v\f\ufeff\p{Zs}]+/yu,a=/\r?\n|[\r\u2028\u2029]/y,c=/\/\*(?:[^*]|\*(?!\/))*(\*\/)?/y,p=/\/\/.*/y,t=/[<>.:={}]|\/(?![\/*])/y,e=/[$_\p{ID_Start}][$_\u200C\u200D\p{ID_Continue}-]*/yu,s=/(['"])(?:(?!\1)[^])*(\1)?/y,n=/[^<>{}]+/y,I=/^(?:[\/+-]|\.{3}|\?(?:InterpolationIn(?:JSX|Template)|NoLineTerminatorHere|NonExpressionParenEnd|UnaryIncDec))?$|[{}([,;<>=*%&|^!~?:]$/,w=/^(?:=>|[;\]){}]|else|\?(?:NoLineTerminatorHere|NonExpressionParenEnd))?$/,i=/^(?:await|case|default|delete|do|else|instanceof|new|return|throw|typeof|void|yield)$/,o=/^(?:return|throw|yield)$/,l=RegExp(a.source),qs=function*(y,{jsx:R=!1}={}){var k,U,q,S,x,ze,T,ve,tn,se,ht,A,dt,W;for({length:ze}=y,S=0,x="",W=[{tag:"JS"}],k=[],ht=0,A=!1;S<ze;){switch(ve=W[W.length-1],ve.tag){case"JS":case"JSNonExpressionParen":case"InterpolationInTemplate":case"InterpolationInJSX":if(y[S]==="/"&&(I.test(x)||i.test(x))&&(d.lastIndex=S,T=d.exec(y))){S=d.lastIndex,x=T[0],A=!0,yield{type:"RegularExpressionLiteral",value:T[0],closed:T[1]!==void 0&&T[1]!=="\\"};continue}if(u.lastIndex=S,T=u.exec(y)){switch(dt=T[0],tn=u.lastIndex,se=dt,dt){case"(":x==="?NonExpressionParenKeyword"&&W.push({tag:"JSNonExpressionParen",nesting:ht}),ht++,A=!1;break;case")":ht--,A=!0,ve.tag==="JSNonExpressionParen"&&ht===ve.nesting&&(W.pop(),se="?NonExpressionParenEnd",A=!1);break;case"{":u.lastIndex=0,q=!w.test(x)&&(I.test(x)||i.test(x)),k.push(q),A=!1;break;case"}":switch(ve.tag){case"InterpolationInTemplate":if(k.length===ve.nesting){v.lastIndex=S,T=v.exec(y),S=v.lastIndex,x=T[0],T[1]==="${"?(x="?InterpolationInTemplate",A=!1,yield{type:"TemplateMiddle",value:T[0]}):(W.pop(),A=!0,yield{type:"TemplateTail",value:T[0],closed:T[1]==="`"});continue}break;case"InterpolationInJSX":if(k.length===ve.nesting){W.pop(),S+=1,x="}",yield{type:"JSXPunctuator",value:"}"};continue}}A=k.pop(),se=A?"?ExpressionBraceEnd":"}";break;case"]":A=!0;break;case"++":case"--":se=A?"?PostfixIncDec":"?UnaryIncDec";break;case"<":if(R&&(I.test(x)||i.test(x))){W.push({tag:"JSXTag"}),S+=1,x="<",yield{type:"JSXPunctuator",value:dt};continue}A=!1;break;default:A=!1}S=tn,x=se,yield{type:"Punctuator",value:dt};continue}if(r.lastIndex=S,T=r.exec(y)){switch(S=r.lastIndex,se=T[0],T[0]){case"for":case"if":case"while":case"with":x!=="."&&x!=="?."&&(se="?NonExpressionParenKeyword")}x=se,A=!i.test(T[0]),yield{type:T[1]==="#"?"PrivateIdentifier":"IdentifierName",value:T[0]};continue}if(b.lastIndex=S,T=b.exec(y)){S=b.lastIndex,x=T[0],A=!0,yield{type:"StringLiteral",value:T[0],closed:T[2]!==void 0};continue}if(f.lastIndex=S,T=f.exec(y)){S=f.lastIndex,x=T[0],A=!0,yield{type:"NumericLiteral",value:T[0]};continue}if(v.lastIndex=S,T=v.exec(y)){S=v.lastIndex,x=T[0],T[1]==="${"?(x="?InterpolationInTemplate",W.push({tag:"InterpolationInTemplate",nesting:k.length}),A=!1,yield{type:"TemplateHead",value:T[0]}):(A=!0,yield{type:"NoSubstitutionTemplate",value:T[0],closed:T[1]==="`"});continue}break;case"JSXTag":case"JSXTagEnd":if(t.lastIndex=S,T=t.exec(y)){switch(S=t.lastIndex,se=T[0],T[0]){case"<":W.push({tag:"JSXTag"});break;case">":W.pop(),x==="/"||ve.tag==="JSXTagEnd"?(se="?JSX",A=!0):W.push({tag:"JSXChildren"});break;case"{":W.push({tag:"InterpolationInJSX",nesting:k.length}),se="?InterpolationInJSX",A=!1;break;case"/":x==="<"&&(W.pop(),W[W.length-1].tag==="JSXChildren"&&W.pop(),W.push({tag:"JSXTagEnd"}))}x=se,yield{type:"JSXPunctuator",value:T[0]};continue}if(e.lastIndex=S,T=e.exec(y)){S=e.lastIndex,x=T[0],yield{type:"JSXIdentifier",value:T[0]};continue}if(s.lastIndex=S,T=s.exec(y)){S=s.lastIndex,x=T[0],yield{type:"JSXString",value:T[0],closed:T[2]!==void 0};continue}break;case"JSXChildren":if(n.lastIndex=S,T=n.exec(y)){S=n.lastIndex,x=T[0],yield{type:"JSXText",value:T[0]};continue}switch(y[S]){case"<":W.push({tag:"JSXTag"}),S++,x="<",yield{type:"JSXPunctuator",value:"<"};continue;case"{":W.push({tag:"InterpolationInJSX",nesting:k.length}),S++,x="?InterpolationInJSX",A=!1,yield{type:"JSXPunctuator",value:"{"};continue}}if(P.lastIndex=S,T=P.exec(y)){S=P.lastIndex,yield{type:"WhiteSpace",value:T[0]};continue}if(a.lastIndex=S,T=a.exec(y)){S=a.lastIndex,A=!1,o.test(x)&&(x="?NoLineTerminatorHere"),yield{type:"LineTerminatorSequence",value:T[0]};continue}if(c.lastIndex=S,T=c.exec(y)){S=c.lastIndex,l.test(T[0])&&(A=!1,o.test(x)&&(x="?NoLineTerminatorHere")),yield{type:"MultiLineComment",value:T[0],closed:T[1]!==void 0};continue}if(p.lastIndex=S,T=p.exec(y)){S=p.lastIndex,A=!1,yield{type:"SingleLineComment",value:T[0]};continue}U=String.fromCodePoint(y.codePointAt(S)),S+=U.length,x=U,A=!1,yield{type:ve.tag.startsWith("JSX")?"JSXInvalid":"Invalid",value:U}}},qs}var Vv=dd();var qa={keyword:["break","case","catch","continue","debugger","default","do","else","finally","for","function","if","return","switch","throw","try","var","const","while","with","new","this","super","class","extends","export","import","null","true","false","in","instanceof","typeof","void","delete"],strict:["implements","interface","let","package","private","protected","public","static","yield"]},qv=new Set(qa.keyword),Wv=new Set(qa.strict);function Wa(r){return r.type==="test"||r.type==="custom"}function yr(r=[]){return Vs(r).flatMap(e=>Wa(e)?[e]:[e,...yr(e.tasks)])}var Ws=new WeakMap;function j(r){let e=Ws.get(r);if(!e)throw new Error(`Test data not found for "${r.label}". This is a bug in Vitest extension. Please report it to https://github.com/vitest-dev/vscode`);return e}function wr(r,e){return Ws.set(r,e),e}var ct=class{label;parent;id;constructor(e,t){this.label=e.label,this.id=e.id,this.parent=t?Ws.get(t):void 0}},K=class r extends ct{type="folder";constructor(e,t){super(e,t)}static register(e,t){return wr(e,new r(e,t))}},H=class r extends ct{constructor(t,s,n,i,o){super(t,s);this.filepath=n;this.api=i;this.project=o}type="file";static register(t,s,n,i,o){return wr(t,new r(t,s,n,i,o))}},Er=class{constructor(e,t){this.data=e;this.dynamic=t}get label(){return this.data.label}getTestNamePattern(){let e=[Ua(this.data.label,this.dynamic)],t=this.data.parent;for(;t&&!(t instanceof H||t instanceof K);)e.push(Ua(t.label,t.name.dynamic)),t=t.parent;return`\\s?${e.reverse().join(" ")}`}},Ge=class r extends ct{constructor(t,s,n,i){super(t,s);this.file=n;this.name=new Er(this,i)}name;type="test";static register(t,s,n,i){return wr(t,new r(t,s,n,i))}getTestNamePattern(){return`^${this.name.getTestNamePattern()}$`}},Tr=class r extends ct{constructor(t,s,n,i){super(t,s);this.file=n;this.name=new Er(this,i)}name;type="suite";static register(t,s,n,i){return wr(t,new r(t,s,n,i))}getTestNamePattern(){return`^${this.name.getTestNamePattern()}`}};function ja(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var pd=new Map([["%i","\\d+?"],["%#","\\d+?"],["%d","[\\d.eE+-]+?"],["%f","[\\d.eE+-]+?"],["%s",".+?"],["%j",".+?"],["%o",".+?"],["%%","%"]]);function Ua(r,e){if(!e)return ja(r);let t=r.replace(/\$[a-z_.]+/gi,"%s");return t=ja(t),t=t.replace(/%[i#dfsjo%]/g,s=>pd.get(s)||s),t}var Xa=require("fs"),_r=O(za());var Ir=new _r.IstanbulCoverageContext;function Ha(r){try{return JSON.parse((0,Xa.readFileSync)(Fr(r,wi),"utf8"))}catch(e){throw new _r.IstanbulMissingCoverageError(r,e)}}function Pr(r){if(process.platform!=="win32")return r;let e=__dirname[0],t=e===e.toUpperCase()?"uppercase":"lowercase",s=r[0];return t==="lowercase"?s.toLowerCase()+r.slice(1):s.toUpperCase()+r.slice(1)}var ut=class extends V.Disposable{constructor(t,s,n){super(()=>{h.verbose?.("Disposing test runner"),n.clearListeners(),this.endTestRun(),this.nonContinuousRequest=void 0,this.continuousRequests.clear(),this.api.cancelRun(),this._onRequestsExhausted.dispose(),this.disposables.forEach(i=>i.dispose()),this.disposables=[]});this.controller=t;this.tree=s;this.api=n;n.onStdout(i=>{this.testRun&&this.testRun.appendOutput(Bs(i))}),n.onWatcherRerun((i,o,a)=>{a?h.verbose?.("Not starting the runner because tests are being collected for",...i.map(c=>this.relative(c))):(h.verbose?.("Starting a test run because",...i.map(c=>this.relative(c)),"triggered a watch rerun event"),this.startTestRun(i))}),n.onTaskUpdate(i=>{i.forEach(([o,a])=>{let c=this.tree.getTestItemByTaskId(o);if(!c){h.error("Cannot find task during onTaskUpdate",o);return}let l=this.testRun;if(!l){h.verbose?.(`There is no test run for "${c.label}"`);return}this.markResult(l,c,a)})}),n.onCollected((i,o)=>{if(!i||!i.length){h.verbose?.("No files to collect");return}i.forEach(a=>this.tree.collectFile(this.api,a)),!o&&yr(i).forEach(a=>{let c=this.tree.getTestItemByTask(a);if(!c){h.error(`Test data not found for "${a.name}"`);return}let l=this.testRun;if(l)if(a.mode==="skip"||a.mode==="todo"){let f=this.testRunRequest?.include;this.testRunRequest&&(!f||this.isTestIncluded(c,f))?(h.verbose?.(`Marking "${c.label}" as skipped`),l.skipped(c)):h.verbose?.(`Ignore "${c.label}" during collection`)}else!a.result&&a.type!=="suite"?(h.verbose?.(`Enqueuing "${c.label}" because it was just collected`),l.enqueued(c)):this.markResult(l,c,a.result)})}),n.onFinished(async(i=[],o,a)=>{let c=this.testRun;if(!c){h.verbose?.("No test run to finish for",i.map(l=>this.relative(l.filepath)).join(", ")),i.length||h.verbose?.("No files to finish"),o&&h.error(o);return}try{a||await this.reportCoverage()}catch(l){te(`Failed to report coverage. ${l.message}`,l)}o&&c.appendOutput(Bs(o)),a||this.endTestRun()}),n.onConsoleLog(({content:i,taskId:o})=>{let a=o?s.getTestItemByTaskId(o):void 0,c=this.testRun;c?c.appendOutput(Bs(i),void 0,a):h.info("[TEST]",i)})}continuousRequests=new Set;nonContinuousRequest;_onRequestsExhausted=new V.EventEmitter;testRun;testRunDefer;testRunRequest;disposables=[];cancelled=!1;endTestRun(){h.verbose?.("Ending test run",this.testRun?this.testRun.name||"":"<none>"),this.testRun?.end(),this.testRunDefer?.resolve(),this.testRun=void 0,this.testRunDefer=void 0,this.testRunRequest=void 0}async watchContinuousTests(t,s){if(this.continuousRequests.add(t),this.disposables.push(s.onCancellationRequested(()=>{h.verbose?.("Continuous test run for",Gs(t.include),"was cancelled"),this.continuousRequests.delete(t),this.continuousRequests.size||(h.verbose?.("Stopped watching test files"),this._onRequestsExhausted.fire(),this.api.unwatchTests(),this.endTestRun())})),!t.include?.length)h.info("[RUNNER]","Watching all test files"),await this.api.watchTests();else{let n=[...this.continuousRequests].map(a=>a.include||[]).flat(),i=Ms(n),o=Ja(n);h.info("[RUNNER]","Watching test files:",i.map(a=>this.relative(a)).join(", "),o?`with pattern ${o}`:""),await this.api.watchTests(i,o)}}async runCoverage(t,s){try{await this.api.enableCoverage()}catch(o){te(`Failed to enable coverage. ${o.message}`,o);return}let{dispose:n}=this._onRequestsExhausted.event(()=>{!this.continuousRequests.size&&!this.nonContinuousRequest&&(h.verbose?.("Coverage was disabled due to all requests being exhausted"),this.api.disableCoverage(),n())});this.disposables.push(s.onCancellationRequested(()=>{h.verbose?.("Coverage for",Gs(t.include),"was manually stopped"),this.api.disableCoverage()}));let i=t.include?Ms(t.include).map(o=>typeof o=="string"?o:o[1]):null;await this.api.invalidateIstanbulTestModules(i),await this.runTests(t,s)}async runTests(t,s){if(t.continuous)return await this.watchContinuousTests(t,s);try{await this.scheduleTestItems(t,s)}catch(n){n.message.startsWith("[birpc] rpc is closed")||h.error("Failed to run tests",n),this.endTestRun()}}scheduleTestRunsQueue=[];async runTestItems(t,s){this.cancelled=!1,this.nonContinuousRequest=t,this.disposables.push(s.onCancellationRequested(()=>{t===this.nonContinuousRequest&&(this.cancelled=!0,this.api.cancelRun().then(()=>{this.nonContinuousRequest=void 0,this.endTestRun()}),h.verbose?.("Test run was cancelled manually for",Gs(t.include)))}));let n=(o,a)=>"updateSnapshots"in t?this.api.updateSnapshots(o,a):this.api.runFiles(o,a),i=t.include||[];if(i.length){let o=Ja(i),a=Ms(i);o?h.info(`Running ${a.length} file(s) with name pattern: ${o}`):h.info(`Running ${a.length} file(s):`,a.map(c=>this.relative(c))),await n(a,o)}else{let o=this.api.workspaceFolder.uri.fsPath;h.info(`Running all tests in ${z(o)}`),await n()}t===this.nonContinuousRequest&&(this.nonContinuousRequest=void 0,this._onRequestsExhausted.fire())}async scheduleTestItems(t,s){if(!this.testRunDefer)await this.runTestItems(t,s);else return h.verbose?.("Queueing a new test run to execute when the current one is finished."),new Promise((n,i)=>{this.scheduleTestRunsQueue.push({runTests:()=>(h.verbose?.("Scheduled test run is starting now."),this.runTestItems(t,s).then(n,i)),resolveWithoutRunning:n})})}isTestIncluded(t,s){for(let n of s){let i="id"in n?n:n[1];if(i===t||this.isTestIncluded(t,i.children))return!0}return!1}isFileIncluded(t,s){for(let n of s){let i="id"in n?n:n[1],o=j(i);if(o instanceof H){if(o.filepath===t)return!0}else if(o instanceof K){if(this.isFileIncluded(t,i.children))return!0}else if(o.file.filepath===t)return!0}return!1}getTestFilesInFolder(t){let s=this.tree.getOrCreateFolderTestItem(this.api,t),n=this.tree.getFolderFiles(s);return Array.from(new Set(n.map(i=>j(i).filepath)))}createContinuousRequest(){if(!this.continuousRequests.size)return null;let t=[],s=null;for(let n of this.continuousRequests)s||(s=n),t.push(...n.include||[]);return new V.TestRunRequest(t.length?t:void 0,void 0,s?.profile,!0)}async startTestRun(t,s){let n=s||this.nonContinuousRequest||this.createContinuousRequest();if(!n){h.verbose?.("No test run request found for",...t.map(c=>this.relative(c)));return}this.testRun&&(h.verbose?.("Waiting for the previous test run to finish"),await this.testRunDefer?.promise);let i=t.length>1?void 0:this.relative(t[0]),o=this.testRun=this.controller.createTestRun(n,i);this.testRunRequest=n,this.testRunDefer=Promise.withResolvers(),this.testRunDefer.promise=this.testRunDefer.promise.finally(()=>{o.end(),this.cancelled?(h.verbose?.("Not starting a new test run because the previous one was cancelled manually."),this.scheduleTestRunsQueue.forEach(c=>c.resolveWithoutRunning()),this.scheduleTestRunsQueue.length=0,this.cancelled=!1):(h.verbose?.(`Test run promise is finished, the queue is ${this.scheduleTestRunsQueue.length}`),this.scheduleTestRunsQueue.shift()?.runTests())});for(let c of t){let f=function(u){let d=j(u);d instanceof Ge&&(h.verbose?.(`Enqueuing "${u.label}"`),o.enqueued(u)),!(d instanceof H&&!t.includes(d.filepath))&&u.children.forEach(f)};var a=f;if(c[c.length-1]==="/"){let u=this.getTestFilesInFolder(c);this.startTestRun(u,n);continue}if(n.include&&!this.isFileIncluded(c,n.include))continue;(n.include||this.tree.getFileTestItems(c)).forEach(u=>f(u))}}async reportCoverage(){if(!("FileCoverage"in V))return;let t=await this.api.waitForCoverageReport(),s=this.testRun;if(!t||!s)return;let n=Ha(t);function i(o){o&&(o.start?.column&&o.start.column<0&&(o.start.column=0),o.end?.column&&o.end.column<0&&(o.end.column=0))}for(let o in n)for(let a in n[o].branchMap){let c=n[o].branchMap[a];i(c.loc),c.locations?.forEach(l=>i(l))}await Ir.applyJson(s,n),(0,Ka.rm)(t,{recursive:!0,force:!0}).then(()=>{h.info("Removed coverage reports",t)}).catch(()=>{h.error("Failed to remove coverage reports",t)})}markTestCase(t,s,n){switch(n.state){case"fail":{let i=n.errors?.map(o=>gd(s,o))||[];if(!i.length){h.verbose?.(`Test failed, but no errors found for "${s.label}"`);return}h.verbose?.(`Marking "${s.label}" as failed with ${i.length} errors`),t.failed(s,i,n.duration);break}case"pass":h.verbose?.(`Marking "${s.label}" as passed`),t.passed(s,n.duration);break;case"todo":case"skip":h.verbose?.(`Marking "${s.label}" as skipped`),t.skipped(s);break;case"only":case"run":h.verbose?.(`Marking "${s.label}" as running`),t.started(s);break;default:{let i=n.state;h.error("Unknown test result for",`${s.label}: ${n.state}`)}}}markNonTestCase(t,s){if(!s){h.verbose?.(`No task result for "${t.label}", ignoring`);return}let n=s.errors?.map(i=>i.stack||i.message);if(!n?.length){h.verbose?.(`No errors found for "${t.label}"`);return}h.verbose?.(`Marking "${t.label}" as failed with ${n.length} errors`),t.error=n.join(`
`)}markResult(t,s,n){if(!(j(s)instanceof Ge)){this.markNonTestCase(s,n);return}if(!n){h.verbose?.(`No task result for "${s.label}", assuming the test just started running`),t.started(s);return}this.markTestCase(t,s,n)}relative(t){return ee(this.api.workspaceFolder.uri.fsPath,typeof t=="string"?t:t[1])}};function gd(r,e){if(!e)return new V.TestMessage("Unknown error");let t;e.actual!=null&&e.expected!=null&&e.actual!=="undefined"&&e.expected!=="undefined"?t=V.TestMessage.diff((0,zs.stripVTControlCharacters)(e.message)??"",e.expected,e.actual):t=new V.TestMessage((0,zs.stripVTControlCharacters)(e.message)??""),yd(t,e.stacks);let s=vd(r,e.stacks??[]);if(s){let n=new V.Position(s.line-1,s.column-1);t.location=new V.Location(V.Uri.file(s.path),n)}return t}function Qa(r){return{sourceFilepath:r.file.replace(/\//g,Ya.default.sep),line:r.line,column:r.column}}function vd(r,e){if(e.length===0)return;let t=r.uri.fsPath;for(let s of e){let{sourceFilepath:n,line:i,column:o}=Qa(s),a=n&&Pr(n);if(!(a!==t||Number.isNaN(o)||Number.isNaN(i)))return{path:a,line:i,column:o}}h.verbose?.("Could not find a valid stack for",r.label,JSON.stringify(e,null,2))}function yd(r,e){if(!("TestMessageStackFrame"in V)||!e||e.length===0)return;let t=V.TestMessageStackFrame,s=e.map(n=>{let{sourceFilepath:i,line:o,column:a}=Qa(n),c=i?V.Uri.file(i):void 0;return new t(n.method,c,new V.Position(o-1,a-1))});r.stackTrace=s}function Ms(r){if(r.some(n=>j(n)instanceof K))return Array.from(new Set(r.map(n=>{let i=j(n),o=L(n.uri.fsPath);return i instanceof K?`${o}/`:o}).filter(Boolean)));let t=[],s=new Set;for(let n of r){let i=n.uri.fsPath,o=j(n);if(o instanceof K)continue;let a=o instanceof H?o.project:o.file.project,c=`${a}\0${i}`;s.has(c)||(s.add(c),t.push([{name:a},i]))}return t}function Ja(r){let e=[];for(let t of r){let s=j(t);"getTestNamePattern"in s&&e.push(s.getTestNamePattern())}if(e.length)return e.join("|")}function Bs(r){return r.replace(/(?<!\r)\n/g,`\r
`)}function Gs(r){return r?r.map(e=>`"${e.label}"`).join(", "):"<all tests>"}var kr=require("fs"),Hs=require("path"),ce=O(require("vscode"));var Xs=require("path"),he=O(require("vscode"));var Cr=class extends he.Disposable{constructor(t){super(()=>{this.reset(),h.verbose?.("[VSCODE] Watcher disposed")});this.testTree=t}watcherByFolder=new Map;apisByFolder=new WeakMap;reset(){this.watcherByFolder.forEach(t=>t.dispose()),this.watcherByFolder.clear()}watchTestFilesInWorkspace(t){let s=t.workspaceFolder,n=this.apisByFolder.get(s)??[];if(n.includes(t)||(h.info("[API] Watching",(0,Xs.relative)(s.uri.fsPath,t.id)),n.push(t)),this.apisByFolder.set(s,n),this.watcherByFolder.has(s))return;let i=new he.RelativePattern(s,N(s).filesWatcherInclude);h.info("[VSCODE] Watching",s.name,"with pattern",i.pattern);let o=he.workspace.createFileSystemWatcher(i);this.watcherByFolder.set(s,o),o.onDidDelete(a=>{h.verbose?.("[VSCODE] File deleted:",this.relative(t,a)),this.testTree.removeFile(L(a.fsPath))}),o.onDidChange(async a=>{let c=L(a.fsPath);if(await this.shouldIgnoreFile(t,c,a))return;h.verbose?.("[VSCODE] File changed:",this.relative(t,a)),(this.apisByFolder.get(s)||[]).forEach(f=>f.onFileChanged(c))}),o.onDidCreate(async a=>{let c=L(a.fsPath);if(await this.shouldIgnoreFile(t,c,a))return;h.verbose?.("[VSCODE] File created:",this.relative(t,a)),(this.apisByFolder.get(s)||[]).forEach(f=>f.onFileChanged(c))})}relative(t,s){return(0,Xs.relative)(t.workspaceFolder.uri.fsPath,s.fsPath)}async shouldIgnoreFile(t,s,n){if(s.includes("/node_modules/")||s.includes("/.git/")||s.endsWith(".git"))return h.verbose?.("[VSCODE] Ignoring file:",this.relative(t,n)),!0;try{let i=await he.workspace.fs.stat(n);return i.type!==he.FileType.File&&i.type!==(he.FileType.File|he.FileType.SymbolicLink)?(h.verbose?.("[VSCODE]",this.relative(t,n),"is not a file. Ignoring."),!0):!1}catch(i){return h.verbose?.("[VSCODE] Error checking file stats:",this.relative(t,n),i),!0}}};var Rr=class extends ce.Disposable{constructor(t,s){super(()=>{this.folderItems.clear(),this.fileItems.clear(),this.flatTestItems.clear(),this.testItemsByFile.clear(),this.watcher.dispose()});this.controller=t;this.loaderItem=s;this.watcher=new Cr(this)}flatTestItems=new Map;fileItems=new Map;folderItems=new Map;testItemsByFile=new Map;testFiles=new Set;watcher;getFileTestItems(t){return this.testItemsByFile.get(L(t))||[]}getAllFileItems(){return Array.from(this.fileItems.values())}reset(t){if(this.folderItems.clear(),this.testItemsByFile.clear(),this.fileItems.clear(),this.flatTestItems.clear(),this.watcher.reset(),this.loaderItem.busy=!0,t.length===1)this.getOrCreateInlineFolderItem(t[0].uri).children.replace([this.loaderItem]);else{let s=t.map(n=>{let i=this.getOrCreateWorkspaceFolderItem(n.uri);return i.children.replace([]),i.busy=!0,i});this.controller.items.replace(s)}}async discoverAllTestFiles(t,s){let n=this.folderItems.get(L(t.workspaceFolder.uri.fsPath));n&&(n.busy=!1);for(let[i,o]of s)this.getOrCreateFileTestItem(t,i,o);return s}getOrCreateInlineFolderItem(t){let s=L(t.fsPath),n=this.folderItems.get(s);if(n)return n;if((0,kr.lstatSync)(t.fsPath).isSymbolicLink()){let c=(0,kr.readlinkSync)(t.fsPath),l=M(t.fsPath);s=(0,Hs.resolve)(l,c),t=ce.Uri.file(s)}let o=this.folderItems.get(s);if(o)return o;let a={id:t.toString(),children:this.controller.items,uri:t,label:"<root>",canResolveChildren:!1,busy:!1,parent:void 0,tags:[],range:void 0,error:void 0};return K.register(a),this.folderItems.set(s,a),a}getOrCreateWorkspaceFolderItem(t){let s=L(t.fsPath),n=this.folderItems.get(s);if(n)return n;let i=this._createFolderItem(t);return this.folderItems.set(s,i),i}getOrCreateFileTestItem(t,s,n){let i=L(n),o=`${i}${s}`,a=this.fileItems.get(o);if(a)return a;let c=ce.Uri.file((0,Hs.resolve)(n)),l=this.getOrCreateFolderTestItem(t,M(n)),f=`${z(n)}${s?` [${s}]`:""}`,u=this.controller.createTestItem(o,f,c);u.tags=[t.tag],u.canResolveChildren=!0,H.register(u,l,i,t,s),l.children.add(u),this.fileItems.set(o,u);let d=this.testItemsByFile.get(i)||[];return d.push(u),this.testItemsByFile.set(i,d),this.testFiles.add(c.fsPath),ce.commands.executeCommand("setContext","vitest.testFiles",Array.from(this.testFiles)),u}getOrCreateFolderTestItem(t,s){let n=this.folderItems.get(s);if(n)return n.tags.includes(t.tag)||(n.tags=[...n.tags,t.tag]),n;let i=ce.Uri.file(s),o=this.getOrCreateFolderTestItem(t,M(s)),a=this._createFolderItem(i,o);return a.tags=[t.tag],o.children.add(a),this.folderItems.set(s,a),a}_createFolderItem(t,s){let n=L(t.fsPath),i=this.controller.createTestItem(n,z(n),t);return K.register(i,s),i.canResolveChildren=!1,i}async watchTestFilesInWorkspace(t,s){await this.discoverAllTestFiles(t,s),this.watcher.watchTestFilesInWorkspace(t)}removeFile(t){this.testItemsByFile.get(L(t))?.forEach(n=>this.recursiveDelete(n))}recursiveDelete(t){if(!t.parent)return;t.parent.children.delete(t.id),this.flatTestItems.delete(t.id);let s=j(t);s instanceof H&&(this.testItemsByFile.delete(s.filepath),this.fileItems.delete(t.id)),s instanceof K&&this.folderItems.delete(t.id),t.parent.children.size||this.recursiveDelete(t.parent)}getAPIFromTestItem(t){return Za(t)}async discoverFileTests(t){let s=j(t);if(!(s instanceof H))return;let n=s.api;if(!n)return h.error(`Cannot find collector for ${t.uri?.fsPath}`),null;t.busy=!0;try{return await n.collectTests(s.project,t.uri.fsPath),t}finally{t.busy=!1}}getTestItemByTaskId(t){let s=this.flatTestItems.get(t);if(s)return s||void 0}getTestItemByTask(t){let s=this.flatTestItems.get(t.id);return s||"filepath"in t&&t.filepath&&this.fileItems.get(`${t.filepath}${t.projectName||""}`)||null}getFolderFiles(t){let s=[];for(let[n,i]of t.children){let o=j(i);o instanceof H?s.push(i):o instanceof K&&s.push(...this.getFolderFiles(i))}return s}collectFile(t,s){let n=this.getOrCreateFileTestItem(t,s.projectName||"",s.filepath);n.error=void 0,this.flatTestItems.set(s.id,n);let i=j(n);if(this.collectTasks(t.tag,i,s.tasks,n),s.result?.errors){let o=s.result.errors.map(a=>a.stack||a.message).join(`
`);n.error=o,h.error(`Error in ${s.filepath}`,o)}else s.tasks.length||(n.error=`No tests found in ${s.filepath}`);n.canResolveChildren=!1}collectTasks(t,s,n,i){for(let a of n){let c=this.flatTestItems.get(a.id);if(c){let d=j(c),p=a.type==="custom"?"test":a.type;d.type!==p&&(i.children.delete(c.id),this.flatTestItems.delete(a.id))}let l=this.flatTestItems.get(a.id)||this.controller.createTestItem(a.id,a.name,i.uri);l.tags=Array.from(new Set([...i.tags,t])),l.error=void 0,l.label=a.name;let f=a.location;if(f){let d=new ce.Position(f.line-1,f.column);l.range=new ce.Range(d,d)}else h.error(`Cannot find location for "${l.label}". Using "id" to sort instead.`),l.sortText=a.id;let u=a.dynamic;if(a.type==="suite"?Tr.register(l,i,s,u):(a.type==="test"||a.type==="custom")&&Ge.register(l,i,s,u),this.flatTestItems.set(a.id,l),i.children.add(l),a.result?.errors){let d=a.result.errors.map(p=>p.stack).join(`
`);l.error=d}"tasks"in a&&this.collectTasks(t,s,a.tasks,l)}let o=new Set(n.map(a=>a.id));i.children.forEach(a=>{o.has(a.id)||i.children.delete(a.id)})}};function Ed(r){let e=j(r);if(e instanceof H)return e.api;if(!(e instanceof K))return null;for(let[,t]of r.children){let s=Za(t);if(s)return s}return null}function Za(r){let e=j(r);return e instanceof K?Ed(r):e instanceof H?e.api:e.file.api}var Lr=require("fs"),Z=O(require("vscode"));var ac=O(ks());var ft=O(require("path"),1);var ec=O(require("process"),1),tc=O(require("path"),1),Nr=O(require("fs"),1),rc=require("url");var sc={directory:"isDirectory",file:"isFile"};function Td(r){if(!Object.hasOwnProperty.call(sc,r))throw new Error(`Invalid type specified: ${r}`)}var wd=(r,e)=>e[sc[r]](),Sd=r=>r instanceof URL?(0,rc.fileURLToPath)(r):r;function Js(r,{cwd:e=ec.default.cwd(),type:t="file",allowSymlinks:s=!0}={}){Td(t),e=Sd(e);let n=s?Nr.default.statSync:Nr.default.lstatSync;for(let i of r)try{let o=n(tc.default.resolve(e,i),{throwIfNoEntry:!1});if(!o)continue;if(wd(t,o))return i}catch{}}var nc=require("url");function Ys(r){return r instanceof URL?(0,nc.fileURLToPath)(r):r}var ic=O(require("fs"),1);var bd=Symbol("findUpStop");function xd(r,e={}){let t=ft.default.resolve(Ys(e.cwd)??""),{root:s}=ft.default.parse(t),n=ft.default.resolve(t,Ys(e.stopAt)??s),i=e.limit??Number.POSITIVE_INFINITY,o=[r].flat(),a=l=>{if(typeof r!="function")return Js(o,l);let f=r(l.cwd);return typeof f=="string"?Js([f],l):f},c=[];for(;;){let l=a({...e,cwd:t});if(l===bd||(l&&c.push(ft.default.resolve(t,l)),t===n||c.length>=i))break;t=ft.default.dirname(t)}return c}function oc(r,e={}){return xd(r,{...e,limit:1})[0]}var _d=require;function $r(r,e){let t=!process.versions.pnp&&Id(r,e);if(t)return{vitestNodePath:Cd(t),vitestPackageJsonPath:t};let s=Pd(e?.uri.fsPath||r);return s?{vitestNodePath:s.vitestNodePath,vitestPackageJsonPath:"vitest/package.json",pnp:{loaderPath:s.pnpLoader,pnpPath:s.pnpPath}}:null}function Id(r,e){let t=N(e).vitestPackagePath;if(t&&!t.endsWith("package.json"))throw new Error(`"vitest.vitestPackagePath" must point to a package.json file, instead got: ${t}`);try{let s=t||require.resolve("vitest/package.json",{paths:[r]});return delete require.cache["vitest/package.json"],delete require.cache[s],s}catch{return null}}function Pd(r){try{let e=oc([".pnp.js",".pnp.cjs"],{cwd:r});if(e==null)return null;let s=_d(e).resolveRequest("vitest/node",Pr(r));return{pnpLoader:require.resolve("./.pnp.loader.mjs",{paths:[M(e)]}),pnpPath:e,vitestNodePath:s}}catch{return null}}function Cd(r){return pe(M(r),"./dist/node.js")}var Or=require;function Rd(r){return r!=null}function kd(r){let e=pe(M(r),"package.json");if((0,Lr.existsSync)(e)){let t=JSON.parse((0,Lr.readFileSync)(e,"utf-8"));return t.dependencies?.vitest||t.devDependencies?.vitest}return!1}function cc(r,e){let t=Z.workspace.getWorkspaceFolder(e);if(!t)throw new Error(`Workspace folder not found for ${e}. Does the file exist?`);let s=M(e.fsPath),n=$r(M(e.fsPath),t);if(!n)return r&&(e.fsPath.includes("vitest.")||kd(t.uri.fsPath))&&Z.window.showWarningMessage(`Vitest not found in "${z(M(e.fsPath))}" folder. Please run \`npm i --save-dev vitest\` to install Vitest.'`),h.error("[API]",`Vitest not found for ${e}.`),null;let i=L(e.fsPath),o=`${z(M(i))}:${z(i)}`;if(n.pnp)return{folder:t,id:i,cwd:s,prefix:o,vitestNodePath:n.vitestNodePath,vitestPackageJsonPath:n.vitestPackageJsonPath,version:"pnp",loader:n.pnp.loaderPath,pnp:n.pnp.pnpPath};let a=Or(n.vitestPackageJsonPath);return Ks(r,n.vitestPackageJsonPath,a)?{folder:t,id:i,cwd:s,prefix:o,vitestPackageJsonPath:n.vitestPackageJsonPath,vitestNodePath:n.vitestNodePath,version:a.version}:null}function Ks(r,e,t){if(t.name!=="vitest")return Z.window.showErrorMessage(`Package was resolved to "${t.name}" instead of "vitest". If you are using "vitest.vitestPackagePath", make sure it points to a "vitest" package.`),delete require.cache[e],!1;if(!(0,ac.gte)(t.version,nr)){let s=`Vitest v${t.version} is not supported. Vitest v${nr} or newer is required.`;return r?Z.window.showWarningMessage(s):h.error("[API]",`Vitest v${t.version} from ${e} is not supported. Vitest v${nr} or newer is required.`),delete require.cache[e],!1}return!0}async function lc(r){let[e,t]=await Promise.all([Od(r),Ld(r)]);if(!e.meta.length&&!t.meta.length){let s=await $d(r);return!s.meta.length&&!s.warned?{configs:Nd(r).meta,workspaces:[]}:{configs:s.meta,workspaces:[]}}return{workspaces:e.meta,configs:t.meta}}function Nd(r){let e=!1,t=[];return Z.workspace.workspaceFolders?.forEach(s=>{let n=L(s.uri.fsPath),i=$r(n,s);if(!i)return;let o=Or(i.vitestPackageJsonPath);if(!Ks(r,i.vitestPackageJsonPath,o)){e=!0;return}let a=L(s.uri.fsPath),c=`${z(n)}:${z(a)}`;t.push({folder:s,id:a,cwd:n,prefix:c,vitestPackageJsonPath:i.vitestPackageJsonPath,vitestNodePath:i.vitestNodePath,version:o.version})}),{meta:t,warned:e}}async function $d(r){let e=N(),t=await Z.workspace.findFiles("**/package.json",e.configSearchPatternExclude),s=!1,n=[];return t.forEach(i=>{let o=Object.entries(Or(i.fsPath).scripts||{}).filter(([,w])=>typeof w=="string"&&w.startsWith("vitest "));if(!o.length)return;let a=Z.workspace.getWorkspaceFolder(i),c=M(i.fsPath),l=$r(c,a);if(!l)return;let f=Or(l.vitestPackageJsonPath);if(!Ks(r,l.vitestPackageJsonPath,f)){s=!0;return}let u=o[0];if(!u)return;let[d,p]=u,b=`${L(i.fsPath)}/${d}`,v=`${z(c)}/package.json:${d}`;n.push({folder:a,id:b,cwd:c,prefix:v,arguments:p,vitestPackageJsonPath:l.vitestPackageJsonPath,vitestNodePath:l.vitestNodePath,version:f.version})}),{meta:Qs(n),warned:s}}async function Od(r){let e=N(),t=e.workspaceConfig,s=e.rootConfig;t&&h.info("[API] Using user workspace config:",t);let n=t?[Z.Uri.file(t)]:await Z.workspace.findFiles(or,e.configSearchPatternExclude),i=!1;return n.length?{meta:Qs(n.map(a=>{let c=cc(r,a);return c?{...c,configFile:s,workspaceFile:c.id}:(i=!0,null)}).filter(Rd)),warned:i}:{meta:[],warned:i}}async function Ld(r){let e=N(),t=e.rootConfig,s=!1;t&&h.info("[API] Using user root config:",t);let i=(t?[Z.Uri.file(t)]:await Z.workspace.findFiles(ir,e.configSearchPatternExclude)).reduce((a,c)=>{let l=M(c.fsPath);return a[l]||(a[l]=[]),a[l].push(c),a},{}),o=[];for(let[a,c]of Object.entries(i))(c.some(u=>z(u.fsPath).includes("vite."))&&c.some(u=>z(u.fsPath).includes("vitest."))?c.filter(u=>!z(u.fsPath).includes("vite.")):c).forEach(u=>{let d=cc(r,u);d?o.push({...d,configFile:d.id}):s=!0});return{meta:Qs(o),warned:s}}function Ad(r){let e=[],t={},s=r.map(n=>n.split("/").reverse().slice(2));return r.forEach((n,i)=>{s[i].forEach(o=>{o&&(t[o]=(t[o]||0)+1)})}),r.forEach((n,i)=>{let o=Number.POSITIVE_INFINITY,a="";s[i].forEach(c=>{t[c]<o&&!e.includes(c)&&(o=t[c],a=c)}),t[a]++,e.push(a)}),e}function Qs(r){let e={},t={};for(let s of r){let{prefix:n,id:i}=s;e[n]||(e[n]=[]),e[n].push(i),t[i]=s}for(let s in e){let n=e[s];if(n.length===1)continue;let i=Ad(n);n.forEach((o,a)=>{let c=z(o),l=i[a];t[o].prefix=`${l}:${c}`})}return r}var Ie=O(require("vscode")),Ar=class extends Ie.Disposable{constructor(t){super(()=>{this.disposables.forEach(s=>s.dispose()),this.disposables=[]});this.testTree=t}disposables=[];openTestTag=new Ie.TestTag("open");activate(){this.disposables.push(Ie.workspace.onDidOpenTextDocument(t=>{this.addFileTag(t.uri,this.openTestTag)}),Ie.workspace.onDidCloseTextDocument(t=>{this.removeFileTag(t.uri,this.openTestTag)})),Ie.window.visibleTextEditors.forEach(({document:t})=>{this.addFileTag(t.uri,this.openTestTag)})}addItemTag(t,s){t.tags.includes(s)||(t.tags=[...t.tags,s]),t.children.forEach(n=>{this.addItemTag(n,s)})}removeItemTag(t,s){t.tags=t.tags.filter(n=>n!==s),t.children.forEach(n=>{this.removeItemTag(n,s)})}removeFileTag(t,s){let n=this.testTree.getFileTestItems(t.fsPath);n&&n.forEach(i=>{this.removeItemTag(i,s)})}addFileTag(t,s){let n=this.testTree.getFileTestItems(t.fsPath);n&&n.forEach(i=>{this.addItemTag(i,s)})}};var uc=require("http"),fc=require("url"),de=O(require("vscode"));async function hc(r,e,t,s,n){let i=await $e(),o=(0,uc.createServer)().listen(i),a=new Ve.default({server:o}),c=`ws://localhost:${i}`,l=N(t.folder),f=Promise.withResolvers(),{runtimeArgs:u,runtimeExecutable:d}=await Fd(t),p=l.env||{},b=l.logLevel;h.info("[DEBUG]","Starting debugging session",d,...u||[]);let v={__name:"Vitest",type:l.shellType==="terminal"?"node-terminal":"pwa-node",request:"launch",name:"Debug Tests",autoAttachChildProcesses:!0,skipFiles:l.debugExclude,...l.debugOutFiles?.length?{outFiles:l.debugOutFiles}:{},smartStep:!0,...l.shellType==="terminal"?{command:`${d} ${ke}`}:{program:ke,runtimeArgs:u,runtimeExecutable:d},cwd:t.cwd,env:{...process.env,...p,VITEST_VSCODE_LOG:p.VITEST_VSCODE_LOG??process.env.VITEST_VSCODE_LOG??b,VITEST_VSCODE:"true",VITEST_WS_ADDRESS:c,TEST:"true",VITEST:"true",NODE_ENV:p.NODE_ENV??process.env.NODE_ENV??"test"}};de.debug.startDebugging(t.folder,v,{suppressDebugView:!0}).then(y=>{y?h.info("[DEBUG] Debugging started"):(f.reject(new Error("Failed to start debugging. See output for more information.")),h.error("[DEBUG] Debugging failed"))},y=>{f.reject(new Error("Failed to start debugging",{cause:y})),h.error("[DEBUG] Start debugging failed"),h.error(y.toString())});let w=[],I=de.debug.onDidStartDebugSession(async y=>{if(y.configuration.__name!=="Vitest")return;if(n.isCancellationRequested){de.debug.stopDebugging(y);return}let R;try{R=await ot(a,t,!0,l.shellType);let k=new Ft(t,{...R,process:new Zs(y,R.ws)}),U=new ut(r,e,k);w.push(k,U),n.onCancellationRequested(async()=>{await R.rpc.close(),await de.debug.stopDebugging(y)}),await U.runTests(s,n),f.resolve()}catch(k){if(k.message.startsWith("[birpc] rpc is closed")){f.resolve();return}f.reject(k)}n.isCancellationRequested||(await R?.rpc.close(),await de.debug.stopDebugging(y))}),P=de.debug.onDidTerminateDebugSession(y=>{y.configuration.__name==="Vitest"&&(w.reverse().forEach(R=>R.dispose()),o.close())});w.push(I,P),await f.promise}async function Fd(r){let e=N(r.folder),t=e.nodeExecArgs||[],s=r.loader,n=r.pnp,i=s&&n?["--require",n,"--experimental-loader",(0,fc.pathToFileURL)(s).toString(),...t]:t;return e.shellType==="child_process"?{runtimeExecutable:e.nodeExecutable||"node",runtimeArgs:i}:{runtimeExecutable:"node",runtimeArgs:i}}var Zs=class{constructor(e,t){this.session=e;this._stopped=new Promise(s=>{let{dispose:n}=de.debug.onDidTerminateDebugSession(i=>{e===i&&(n(),s(),this._onDidExit.fire(),this._onDidExit.dispose(),this.closed=!0)})}),t.on("close",()=>{this.close()})}id=Math.random();closed=!1;_stopped;_onDidExit=new de.EventEmitter;close(){return de.debug.stopDebugging(this.session),this._stopped}onError(){return()=>{}}onExit(e){let{dispose:t}=this._onDidExit.event(()=>{e(null)});return t}};async function Dd(r){let e=new en;r.subscriptions.push(e),await e.activate()}function Vd(){}var en=class{testController;loadingTestItem;runProfiles=new Map;testTree;tagsManager;api;runners=[];disposables=[];_debugDisposable;constructor(){h.info(`[v${on}] Vitest extension is activated because Vitest is installed or there is a Vite/Vitest config file in the workspace.`),this.testController=C.tests.createTestController(cn,"Vitest"),this.testController.refreshHandler=e=>this.defineTestProfiles(!0,e).catch(t=>{te("Failed to refresh Vitest",t)}),this.testController.resolveHandler=e=>this.resolveTestFile(e),this.loadingTestItem=this.testController.createTestItem("_resolving","Resolving Vitest..."),this.loadingTestItem.sortText=".0",this.testTree=new Rr(this.testController,this.loadingTestItem),this.tagsManager=new Ar(this.testTree)}_defineTestProfilePromise;async defineTestProfiles(e,t){return this._defineTestProfilePromise||(this._defineTestProfilePromise=this._defineTestProfiles(e,t).finally(()=>{this._defineTestProfilePromise=void 0})),await this._defineTestProfilePromise}async _defineTestProfiles(e,t){this.testTree.reset([]),this.runners.forEach(a=>a.dispose()),this.runners=[];let{workspaces:s,configs:n}=await lc(e);if(t?.isCancellationRequested)return;if(!s.length&&!n.length){h.error("[API]","Failed to start Vitest: No vitest config files found"),this.testController.items.delete(this.loadingTestItem.id),await this.api?.dispose();return}let i=new Set([...s,...n].map(a=>a.folder));this.testTree.reset(Array.from(i));let o=this.runProfiles;this.runProfiles=new Map;try{if(await this.api?.dispose(),t?.isCancellationRequested)return;this.api=await $a(s,n),this.api.onUnexpectedExit(a=>{a?(te("Vitest process exited unexpectedly"),this.testTree.reset([]),this.testController.items.delete(this.loadingTestItem.id),this.api?.dispose(),this.api=void 0):(h.info("[API] Reloading API due to unexpected empty exit code."),this.api?.dispose(),this.api=void 0,this.defineTestProfiles(!1).catch(c=>{h.error("[API]","Failed to refresh Vitest",c)}))});for(let a of this.api.folderAPIs){let c=await a.getFiles();await this.testTree.watchTestFilesInWorkspace(a,c)}}catch(a){this.testTree.reset([]),te("Failed to start Vitest",a);return}finally{this.testController.items.delete(this.loadingTestItem.id)}this.api.forEach(a=>{let c=new ut(this.testController,this.testTree,a);this.runners.push(c);let l=a.prefix,f=o.get(`${a.id}:run`);f||(f=this.testController.createRunProfile(l,C.TestRunProfileKind.Run,()=>{h.error("Run handler is not defined")},!1,void 0,!0)),f.tag=a.tag,f.runHandler=(d,p)=>c.runTests(d,p),this.runProfiles.set(`${a.id}:run`,f);let u=o.get(`${a.id}:debug`);if(u||(u=this.testController.createRunProfile(l,C.TestRunProfileKind.Debug,()=>{h.error("Run handler is not defined")},!1,void 0,!1)),u.tag=a.tag,u.runHandler=async(d,p)=>{await this.registerDebugOptions(),await hc(this.testController,this.testTree,a.package,d,p)},this.runProfiles.set(`${a.id}:debug`,u),C.TestRunProfileKind.Coverage&&"FileCoverage"in C){let d=o.get(`${a.id}:coverage`);d||(d=this.testController.createRunProfile(l,C.TestRunProfileKind.Coverage,()=>{h.error("Run handler is not defined")},!1,void 0,!0)),d.tag=a.tag,d.runHandler=(p,b)=>c.runCoverage(p,b),d.loadDetailedCoverage=Ir.loadDetailedCoverage,this.runProfiles.set(`${a.id}:coverage`,d)}});for(let[a,c]of o)this.runProfiles.has(a)||c.dispose();C.window.visibleTextEditors.forEach(async a=>{let c=this.testTree.getFileTestItems(a.document.uri.fsPath),l=[];for(let f of c)j(f)instanceof H&&l.push(this.resolveTestFile(f));await Promise.all(l).catch(f=>{h.error("Failed to collect tests from visible text editors",f)})})}async resolveTestFile(e){if(e)try{await this.testTree.discoverFileTests(e)}catch(t){te("There was an error during test discovery",t)}}async activate(){this.loadingTestItem.busy=!0,this.testController.items.replace([this.loadingTestItem]);let e=["vitest.vitestPackagePath","vitest.nodeExecutable","vitest.nodeExecArgs","vitest.workspaceConfig","vitest.rootConfig","vitest.shellType","vitest.terminalShellArgs","vitest.terminalShellPath","vitest.filesWatcherInclude","vitest.experimentalStaticAstCollect","vitest.cliArguments"];this.disposables=[C.workspace.onDidChangeConfiguration(n=>{e.some(i=>n.affectsConfiguration(i))&&this.defineTestProfiles(!1)}),C.workspace.onDidChangeWorkspaceFolders(()=>this.defineTestProfiles(!1)),C.commands.registerCommand("vitest.openOutput",()=>{h.openOuput()}),C.commands.registerCommand("vitest.revealInTestExplorer",async n=>{if(n===void 0&&(n=C.window.activeTextEditor?.document.uri),!(n instanceof C.Uri))return;let i=this.testTree.getFileTestItems(n.fsPath);i[0]&&C.commands.executeCommand("vscode.revealTestInExplorer",i[0])}),C.commands.registerCommand("vitest.showShellTerminal",async()=>{let n=this.api?.folderAPIs.filter(o=>o.process instanceof Lt);if(!n?.length){C.window.showInformationMessage("No shell terminals found. Did you change `vitest.shellType` to `terminal` in the configuration?");return}if(n.length===1){h.info("Showing the only available shell terminal"),n[0].process.show();return}let i=await C.window.showQuickPick(n.map(o=>({label:o.prefix,process:o.process})));i&&(h.info("Showing picked shell terminal:",i.label),i.process.show())}),C.commands.registerCommand("vitest.updateSnapshot",async n=>{if(!n)return;let i=this.testTree.getAPIFromTestItem(n);if(!i)return;let o=this.runProfiles.get(`${i.id}:run`);if(!o)return;let a=new C.TestRunRequest([n],void 0,o,!1);Object.assign(a,{updateSnapshots:!0});let c=new C.CancellationTokenSource;await o.runHandler(a,c.token)})];let t=[C.workspace.createFileSystemWatcher(ir),C.workspace.createFileSystemWatcher(or)];this.disposables.push(...t);let s=Wr((n,i)=>{if(!this.api||n.fsPath.includes("node_modules")||n.fsPath.includes(".timestamp-"))return;if(i==="create"){this.defineTestProfiles(!1).catch(a=>{h.error("Failed to define test profiles after a new config file was created",a)});return}let o=L(n.fsPath);for(let a of this.api.folderAPIs)if(a.package.workspaceFile===o||a.configs.includes(o)){this.defineTestProfiles(!1).catch(c=>{h.error("Failed to define test profiles after a new config file was updated",c)});return}},300);t.forEach(n=>n.onDidChange(i=>s(i,"change"))),t.forEach(n=>n.onDidCreate(i=>s(i,"create"))),t.forEach(n=>n.onDidDelete(i=>s(i,"delete")));try{await this.defineTestProfiles(!0),this.tagsManager.activate()}catch(n){te("There was an error during Vitest startup",n)}}async registerDebugOptions(){if(!(this._debugDisposable||N().shellType!=="terminal"))try{let t=C.extensions.getExtension("ms-vscode.js-debug-nightly")||C.extensions.getExtension("ms-vscode.js-debug");await t?.activate();let s=t?.exports;s?(this._debugDisposable=s.registerDebugTerminalOptionsProvider({provideTerminalOptions(n){return n.shellArgs=N().terminalShellArgs,n.shellPath=N().terminalShellPath,n}}),this.disposables.push(this._debugDisposable)):h.error("Failed to connect to the debug extension. Debugger will open a terminal window.")}catch(t){h.error("Cannot create debug options provider.",t)}}async dispose(){this.api?.dispose(),this.testTree.dispose(),this.tagsManager.dispose(),this.testController.dispose(),this.runProfiles.forEach(e=>e.dispose()),this.runProfiles.clear(),this.disposables.forEach(e=>e.dispose()),this.disposables=[],this.runners.forEach(e=>e.dispose()),this.runners=[]}};0&&(module.exports={activate,deactivate});
