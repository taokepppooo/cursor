exports.id=696,exports.ids=[696],exports.modules={930:(t,e,i)=>{i.d(e,{TimelineWebviewProvider:()=>TimelineWebviewProvider});var s=i(1398),o=i(5811),r=i(2251),a=i(6347),n=i(5823),h=i(5302),l=i(9189),d=i(156),c=i(4143),u=i(4018),p=i(5487),g=i(212),m=i(4007),b=i(124),v=i(5270),y=i(8423),f=i(471),S=i(1261),w=i(9371),T=i(701),x=i(3503);let C="timeline",D=new x.Q2(C,"point/open"),_=new x.Q2(C,"period/update"),R=new x.C1(C,"didChange");var P=Object.defineProperty,U=Object.getOwnPropertyDescriptor,H=(t,e,i,s)=>{for(var o,r=s>1?void 0:s?U(e,i):e,a=t.length-1;a>=0;a--)(o=t[a])&&(r=(s?o(e,i,r):o(r))||r);return s&&r&&P(e,i,r),r};let TimelineWebviewProvider=class TimelineWebviewProvider{constructor(t,e){this.container=t,this.host=e,this._context={uri:void 0,period:"3|M",etagRepositories:this.container.git.etag,etagRepository:0,etagSubscription:this.container.subscription.etag},this.host.isHost("editor")?this._disposable=s.Disposable.from(this.container.subscription.onDidChange(this.onSubscriptionChanged,this),this.container.git.onDidChangeRepository(this.onRepositoryChanged,this)):(this.host.description=o.lD,this._disposable=s.Disposable.from(this.container.subscription.onDidChange(this.onSubscriptionChanged,this),this.container.git.onDidChangeRepository(this.onRepositoryChanged,this),this.container.git.onDidChangeRepositories(this.onRepositoriesChanged,this),s.window.tabGroups.onDidChangeTabGroups(this.onTabsChanged,this),s.window.tabGroups.onDidChangeTabs(this.onTabsChanged,this),this.container.events.on("file:selected",(0,b.sg)(this.onFileSelected,250),this)))}_context;_disposable;get activeTabUri(){return(0,p.ek)(s.window.tabGroups.activeTabGroup.activeTab)}dispose(){this._disposable.dispose()}onReloaded(){this.updateState(!0)}canReuseInstance(...t){let e;let[i]=t;return null!=i?i instanceof s.Uri?e=i:(0,S.kw)(i)?e=i.uri:(0,T.c)(i)&&null!=i.state.uri&&(e=s.Uri.parse(i.state.uri)):e=this.activeTabUri,e?.toString()===this._context.uri?.toString()||void 0}getSplitArgs(){return null!=this._context.uri?[this._context.uri]:[]}getTelemetryContext(){return{...this.host.getTelemetryContext(),"context.period":this._context.period}}onShowing(t,e,...i){let o;let[r]=i;null!=r&&(r instanceof s.Uri?o=r:(0,w.sN)(r)&&("folder"===r.type||(0,S.kw)(r))?o=r.uri:(0,T.c)(r)&&(this._context.period=r.state.period,this.host.isHost("editor")&&(o=null!=r.state.uri?s.Uri.parse(r.state.uri):void 0))),this.updateUri(o??this.activeTabUri,!0),t||this.updateState();let a=(0,y.Bq)(c.H.get("visualHistory"),"context.config",{joinArrays:!0});return[!0,{...this.getTelemetryContext(),...a,"context.period":this._context.period}]}includeBootstrap(){return this.getState(this._context)}registerCommands(){let t=[];return this.host.isHost("view")&&t.push((0,d.Lb)(`${this.host.id}.refresh`,()=>this.host.refresh(!0),this),(0,d.Lb)(`${this.host.id}.openInTab`,()=>{null!=this._context.uri&&((0,d.RS)(r.d.ShowFileInTimeline,this._context.uri),this.container.telemetry.sendEvent("timeline/action/openInEditor",this.getTelemetryContext()))},this)),t}onVisibilityChanged(t){t&&this.host.isHost("view")&&this.updateUri(this.activeTabUri)}async onMessageReceived(t){switch(!0){case D.is(t):{if(null==t.params.data||!t.params.data.selected||null==this._context.uri)return;let e=this.container.git.getRepository(this._context.uri);if(null==e)return;let i=await e.git.commits().getCommit(t.params.data.id);if(null==i)return;this.container.events.fire("commit:selected",{commit:i,interaction:"active",preserveFocus:!0,preserveVisibility:!1},{source:this.host.id}),this.container.telemetry.sendEvent("timeline/commit/selected",this.getTelemetryContext()),this.container.views.commitDetails.ready||this.container.views.commitDetails.show({preserveFocus:!0},{commit:i,interaction:"active",preserveVisibility:!1});break}case _.is(t):if(this._context.period===t.params.period)return;this.container.telemetry.sendEvent("timeline/period/changed",{...this.getTelemetryContext(),"period.old":this._context.period,"period.new":t.params.period}),this._context.period=t.params.period,this.updateState(!0)}}onTabsChanged(){this.updateUri(this.activeTabUri)}onFileSelected(t){if(null==t.data)return;let e=t.data.uri;null==e||this.container.git.isTrackable(e)||(e=void 0),this.updateUri(this.activeTabUri)}onRepositoriesChanged(t){this._context.etagRepositories!==t.etag&&(this._context.etagRepositories=t.etag,this.updateState())}onRepositoryChanged(t){t.changed(h.Z_.Heads,h.Z_.Index,h.Ti.Any)&&this._context.etagRepository!==t.repository.etag&&(this._context.etagRepository=t.repository.etag,this.updateState())}onSubscriptionChanged(t){this._context.etagSubscription!==t.etag&&(this._context.etagSubscription=t.etag,this.updateState())}async getState(t){let e=c.H.get("defaultDateFormat")??"MMMM Do, YYYY h:mma",i=c.H.get("defaultDateShortFormat")??"short",s=t.period??"3|M",r=null!=t.uri?await n.nk.fromUri(t.uri):void 0,h=r?.repoPath,l=null!=t.uri&&await (0,u.ZA)(t.uri);if(this.host.isHost("editor")){let t=l?"Visual Folder History":"Visual File History";this.host.title=null==r?t:`${t}: ${r.fileName}`}else this.host.description=r?.fileName??o.lD;let d=await this.container.git.access(a.kU.Timeline,h);return!1===d.allowed?{...this.host.baseWebviewState,dataset:Promise.resolve(function(){let t=[],e=["Eric Amodio","Justin Roberts","Keith Daulton","Ramin Tadayon","Ada Lovelace","Grace Hopper"];for(let i=0;i<10;i++){let s=new Date(new Date().getTime()-Math.floor(7776e6*Math.random()));t.push({commit:String(i),author:e[Math.floor(Math.random()*e.length)],date:s.toISOString(),message:"",additions:0===i?2:9===i?50:Math.floor(20*Math.random())+1,deletions:0===i?1:9===i?25:Math.floor(20*Math.random())+1,sort:s.getTime()})}return t.sort((t,e)=>e.sort-t.sort)}()),period:s,title:"src/app/index.ts",sha:void 0,uri:t.uri?.toString(),uriType:l?"folder":"file",dateFormat:e,shortDateFormat:i,access:d}:null==t.uri||null==r||null==h?{...this.host.baseWebviewState,period:s,title:r?.relativePath,sha:r?.shortSha,uri:t.uri?.toString(),uriType:l?"folder":"file",dateFormat:e,shortDateFormat:i,access:d}:{...this.host.baseWebviewState,dataset:this.getDataset(r,s),period:s,title:r.relativePath,sha:r.shortSha,uri:t.uri.toString(),uriType:l?"folder":"file",dateFormat:e,shortDateFormat:i,access:d}}async getDataset(t,e){let i=t.repoPath,[o,r]=await Promise.allSettled([this.container.git.getCurrentUser(i),this.container.git.commits(i).getLogForFile(t.fsPath,t.sha,{limit:0,since:(function(t){let e;if("all"===t)return;let[i,s]=t.split("|");switch(s){case"D":e=(0,g.Tl)(new Date,{days:-parseInt(i,10)});break;case"M":e=(0,g.Tl)(new Date,{months:-parseInt(i,10)});break;case"Y":e=(0,g.Tl)(new Date,{years:-parseInt(i,10)});break;default:e=(0,g.Tl)(new Date,{months:-3})}return e.getHours()>=12&&e.setDate(e.getDate()+1),e.setHours(0,0,0,0),e})(e)?.toISOString()})]),a=(0,f.Ro)(r);if(null==a)return[];let n=(0,f.Ro)(o),h=[...(0,v.pb)(a.commits.values(),t=>t.file?.stats==null&&1!==(0,l.Zx)(t.stats?.files))];if(0!==h.length){let e=c.H.get("visualHistory.queryLimit")??20,i=this.container.git.getRepository(t),o=i?.provider.name;h.length>e&&(s.window.showWarningMessage(`Unable able to show more than the first ${e} commits for the specified time period because of ${o?`${o} `:""}rate limits.`),h=h.slice(0,20)),await Promise.allSettled(h.map(t=>t.ensureFullDetails()))}let d=n?.name?`${n.name} (you)`:"You",u=[];for(let t of a.commits.values()){let e=t.file?.stats??(1===(0,l.Zx)(t.stats?.files)?t.stats:void 0);u.push({author:"You"===t.author.name?d:t.author.name,additions:e?.additions,deletions:e?.deletions,commit:t.sha,date:t.date.toISOString(),message:t.message??t.summary,sort:t.date.getTime()})}return u.sort((t,e)=>e.sort-t.sort),u}updateUri(t,e){let i;if(null!=t){let e=this.container.git.getRepository(t);i=e?.etag??0}else i=0;if(this._context.etagRepository!==i||this._context.uri?.toString()!==t?.toString()){if(this._context.etagRepository=i,this._context.uri=t,e)return;this.container.telemetry.sendEvent("timeline/editor/changed",this.getTelemetryContext()),this.updateState()}}_notifyDidChangeStateDebounced=void 0;updateState(t=!1){if(t){this.notifyDidChangeState();return}this._notifyDidChangeStateDebounced??=(0,b.sg)(this.notifyDidChangeState.bind(this),500),this._notifyDidChangeStateDebounced()}async notifyDidChangeState(){return this._notifyDidChangeStateDebounced?.cancel(),this.host.notify(R,{state:await this.getState(this._context)})}};H([(0,m.Yz)()],TimelineWebviewProvider.prototype,"onTabsChanged",1),H([(0,m.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onFileSelected",1),H([(0,m.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onRepositoriesChanged",1),H([(0,m.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onRepositoryChanged",1),H([(0,m.Yz)({args:!1})],TimelineWebviewProvider.prototype,"onSubscriptionChanged",1),H([(0,m.Yz)({args:!1})],TimelineWebviewProvider.prototype,"getState",1),H([(0,m.Yz)()],TimelineWebviewProvider.prototype,"updateState",1),H([(0,m.Yz)()],TimelineWebviewProvider.prototype,"notifyDidChangeState",1)}};